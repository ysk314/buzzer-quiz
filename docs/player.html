<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¯ æ—©æŠ¼ã—ã‚¯ã‚¤ã‚º - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        .player-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-name {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .my-score {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .buzzer-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
        }

        .status-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            min-height: 40px;
        }

        .status-waiting {
            color: var(--text-secondary);
        }

        .status-open {
            color: var(--accent-cyan);
            animation: blink 0.5s ease infinite;
        }

        .status-pressed {
            color: var(--accent-yellow);
        }

        .status-winner {
            color: var(--accent-green);
        }

        .status-locked {
            color: var(--accent-red);
        }

        .bottom-section {
            margin-top: auto;
        }

        .ranking-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .round-badge {
            background: var(--accent-purple);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .join-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .join-card {
            max-width: 500px;
            width: 100%;
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-content {
            text-align: center;
            animation: resultPop 0.5s ease;
        }

        @keyframes resultPop {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .result-icon {
            font-size: 8rem;
            margin-bottom: 16px;
        }

        .result-text {
            font-size: 2rem;
            font-weight: 700;
        }

        /* çµ‚äº†ç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-finished .buzzer-area {
            display: none;
        }

        .game-finished .bottom-section {
            flex: 1;
            margin-top: 20px;
        }

        .game-finished .ranking-card {
            min-height: 60vh;
        }
    </style>
</head>

<body>
    <!-- å‚åŠ ç”»é¢ -->
    <div id="joinScreen" class="join-screen">
        <div class="card join-card text-center">
            <h1>ğŸ® å‚åŠ </h1>

            <div id="roomCodeSection">
                <p class="text-secondary mb-md">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <div class="input-group">
                    <input type="text" class="input" id="roomCodeInput" placeholder="ROOM-CODE" maxlength="6"
                        style="text-align: center; font-size: 1.5rem; letter-spacing: 8px; text-transform: uppercase;">
                </div>
                <button class="btn btn-primary" id="checkRoomBtn">ãƒ«ãƒ¼ãƒ ã‚’ç¢ºèª</button>
            </div>

            <div id="nameSection" class="hidden">
                <p class="text-secondary mb-md">åå‰ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div id="nameOptions" class="name-options"></div>
                <button class="btn btn-secondary mt-md" id="shuffleNamesBtn">
                    ğŸ”„ ä»–ã®åå‰ã‚’è¦‹ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="player-container hidden">
        <header class="player-header">
            <div class="player-info" style="display: flex; align-items: center; gap: 8px;">
                <button id="exitBtn" class="btn btn-small btn-secondary">â†</button>
                <span class="my-name" id="myName">---</span>
            </div>
            <div class="my-score"><span id="myScore">0</span>pt</div>
        </header>

        <div class="buzzer-area">
            <div class="status-text" id="statusText">æ¥ç¶šä¸­...</div>
            <button class="buzzer-btn" id="buzzerBtn" disabled>
                <span id="buzzerText">PUSH!</span>
            </button>
        </div>

        <div class="bottom-section">
            <div class="ranking-card">
                <div class="ranking-header">
                    <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <span class="round-badge">ç¬¬<span id="roundNumber">1</span>å•</span>
                </div>
                <ul class="ranking-list" id="rankingList">
                    <li class="text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ä¸­...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="resultOverlay" class="result-overlay">
        <div class="result-content" id="resultContent">
            <div class="result-icon" id="resultIcon">â­•</div>
            <div class="result-text" id="resultText">æ­£è§£ï¼</div>
        </div>
    </div>

    <script src="js/firebase-app.js"></script>
    <script>
        // åå‰å€™è£œãƒ‡ãƒ¼ã‚¿
        const namesData = {
            modifiers: ["ä¼èª¬ã®", "é—‡ã‚ˆã‚Šå‡ºã§ã—", "ä¸–ç•Œã‚’æ•‘ã†", "ãƒ¬ãƒ™ãƒ«99ã®", "è¦šé†’ã—ãŸ", "éŠ€æ²³æœ€å¼·ã®", "å°å°ã•ã‚Œã—", "1000å¹´ã«ä¸€äººã®", "å¥‡è·¡ã®", "æš´èµ°ã™ã‚‹", "ç¥ã«é¸ã°ã‚ŒãŸ", "æ¼†é»’ã®ç¿¼ã‚’æŒã¤", "å…¨å®‡å®™ã®", "æœ€çµ‚å½¢æ…‹ã®", "å¿…æ®ºæŠ€ã‚’æ”¾ã¤", "é™ç•Œçªç ´ã—ãŸ", "éŸ³é€Ÿã®", "æ™‚ã‚’ã‹ã‘ã‚‹", "æœªæ¥ã‹ã‚‰æ¥ãŸ", "è¬ã®çµ„ç¹”ã®", "ç‚ã‚’ã¾ã¨ã†", "æ°·ã®å¿ƒã‚’æŒã¤", "ç„¡æ•µã®", "é»„é‡‘ã®", "å¾©è®ã‚’èª“ã†", "æ°¸é ã®", "å¹»ã®", "è¦‡ç‹è‰²ã®", "æ®‹åƒãŒè¦‹ãˆã‚‹", "ã‚¹ãƒ¼ãƒ‘ãƒ¼", "ãƒ¡ã‚¬é€²åŒ–", "å·¨å¤§åŒ–ã—ãŸ", "åœ°ç„ã‹ã‚‰ã®ä½¿è€…", "ç©ºã‚’é£›ã¶", "é€æ˜äººé–“ã®", "é‹¼é‰„ã®", "å®¿é¡Œã‚’å¿˜ã‚ŒãŸ", "çµ¦é£Ÿå½“ç•ªã®", "å»Šä¸‹ã«ç«‹ãŸã•ã‚ŒãŸ", "ãƒ†ã‚¹ãƒˆ0ç‚¹ã®", "ãƒ†ã‚¹ãƒˆ100ç‚¹ã®", "å¤ä¼‘ã¿ä¸­ã®", "å±…æ®‹ã‚Šã•ã›ã‚‰ã‚ŒãŸ", "æ”¾é€å§”å“¡ã®", "å›³æ›¸å®¤ã®ä¸»", "ä¿å¥å®¤ã§å¯ã¦ã„ã‚‹", "é‹å‹•ä¼šã§è»¢ã‚“ã ", "ç´…ç™½å¸½ã‚’ã‹ã¶ã£ãŸ", "ä¸Šå±¥ãã‚’å¿˜ã‚ŒãŸ", "ãƒ—ãƒ¼ãƒ«ãŒè¦‹å­¦ã®", "æ ¡é•·å…ˆç”Ÿã®", "é è¶³ã®ãŠã‚„ã¤ã‚’æŒã£ãŸ", "ã‚¯ãƒ©ã‚¹ã®äººæ°—è€…", "å­¦ç´šå§”å“¡é•·", "ç”Ÿå¾’ä¼šé•·", "éƒ¨æ´»ã‚’ã‚µãƒœã£ãŸ", "å…ˆç”Ÿã«æ€’ã‚‰ã‚ŒãŸ", "å¯åŠã—ãŸ", "å¯ç™–ãŒã²ã©ã„", "ã‚²ãƒ¼ãƒ ç¦æ­¢ä¸­ã®", "ã‚¹ãƒãƒ›æ²¡åã•ã‚ŒãŸ", "Wi-Fiã‚’æ¢ã—ã¦ã„ã‚‹", "ç­‹è‚‰ç—›ã®", "è‡ªç§°ã‚¤ã‚±ãƒ¡ãƒ³ã®", "ã™ãæ³£ã", "æ–¹å‘éŸ³ç—´ã®", "éŸ³ç—´ãª", "é‡ç”Ÿã®", "ãƒšãƒƒãƒˆã®", "çŒ«è€³ã®", "ã‚´ãƒªãƒ©ã£ã½ã„", "AIæ­è¼‰ã®", "YouTuberã®", "ãƒ—ãƒ­ã‚²ãƒ¼ãƒãƒ¼", "èª²é‡‘å‹¢ã®", "æ­£ç¾©ã®", "æ‚ªã®", "è¿‘æ‰€ã®", "è¬ã®", "åˆä»£", "å…ƒç¥–", "ãƒ‹ã‚»ãƒ¢ãƒã®", "é‡ç”£å‹", "ã‚­ãƒ©ã‚­ãƒ©ã®", "æ—¥æœ¬ä»£è¡¨", "ä¸–ç•Œãƒ©ãƒ³ã‚¯1ä½ã®", "æŒ‡åæ‰‹é…ä¸­ã®", "è„±èµ°ä¸­ã®", "å®‡å®™äºº"],
            characters: ["ç¹”ç”°ä¿¡é•·", "è±Šè‡£ç§€å‰", "å¾³å·å®¶åº·", "å‚æœ¬é¾é¦¬", "è¥¿éƒ·éš†ç››", "è–å¾³å¤ªå­", "å‘å¼¥å‘¼", "æºé ¼æœ", "æºç¾©çµŒ", "æ­¦ç”°ä¿¡ç„", "ä¸Šæ‰è¬™ä¿¡", "ä¼Šé”æ”¿å®—", "çœŸç”°å¹¸æ‘", "åƒåˆ©ä¼‘", "æ¾å°¾èŠ­è•‰", "ç´«å¼éƒ¨", "æ¸…å°‘ç´è¨€", "ç¦æ²¢è«­å‰", "é‡å£è‹±ä¸–", "å¤ç›®æ¼±çŸ³", "å®®æ²¢è³¢æ²»", "åœŸæ–¹æ­³ä¸‰", "æœéƒ¨åŠè”µ", "è‘›é£¾åŒ—æ–", "ä¸€ä¼‘ã•ã‚“", "æ°´æˆ¸é»„é–€", "ãƒŠãƒãƒ¬ã‚ªãƒ³", "ã‚¨ã‚¸ã‚½ãƒ³", "ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³", "ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³", "ãƒ™ãƒ¼ãƒˆãƒ¼ãƒ´ã‚§ãƒ³", "ãƒ¢ãƒ¼ãƒ„ã‚¡ãƒ«ãƒˆ", "è«¸è‘›å­”æ˜", "ã‚¯ãƒ¬ã‚ªãƒ‘ãƒˆãƒ©", "ãƒªãƒ³ã‚«ãƒ¼ãƒ³", "ã‚¬ãƒ³ã‚¸ãƒ¼", "ã‚³ãƒ­ãƒ³ãƒ–ã‚¹", "ã‚­ãƒ¥ãƒªãƒ¼å¤«äºº", "ãƒ¬ã‚ªãƒŠãƒ«ãƒ‰ãƒ»ãƒ€ãƒ»ãƒ´ã‚£ãƒ³ãƒ", "ãƒ”ã‚«ã‚½", "ã‚´ãƒƒãƒ›", "ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³", "ã‚¸ãƒ£ãƒ³ãƒŒãƒ»ãƒ€ãƒ«ã‚¯", "ã‚¦ã‚©ãƒ«ãƒˆãƒ»ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼", "ã‚¹ãƒ†ã‚£ãƒ¼ãƒ–ãƒ»ã‚¸ãƒ§ãƒ–ã‚º", "ãƒ‰ãƒ©ãˆã‚‚ã‚“", "ã®ã³å¤ª", "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³", "ã‚¹ãƒå¤«", "ã—ãšã‹ã¡ã‚ƒã‚“", "ãƒ”ã‚«ãƒãƒ¥ã‚¦", "ã‚µãƒˆã‚·", "ãƒãƒªã‚ª", "ãƒ«ã‚¤ãƒ¼ã‚¸", "ã‚¯ãƒƒãƒ‘", "æ˜Ÿã®ã‚«ãƒ¼ãƒ“ã‚£", "ã‚¢ãƒ³ãƒ‘ãƒ³ãƒãƒ³", "ãƒã‚¤ã‚­ãƒ³ãƒãƒ³", "å­«æ‚Ÿç©º", "ãƒ™ã‚¸ãƒ¼ã‚¿", "ãƒ•ãƒªãƒ¼ã‚¶", "ãƒ«ãƒ•ã‚£", "ã‚¾ãƒ­", "ãƒŠãƒŸ", "ãƒãƒ§ãƒƒãƒ‘ãƒ¼", "æ±Ÿæˆ¸å·ã‚³ãƒŠãƒ³", "æ€ªç›—ã‚­ãƒƒãƒ‰", "é‡åŸã—ã‚“ã®ã™ã‘", "ä¸¡æ´¥å‹˜å‰", "ã‚»ãƒ¼ãƒ©ãƒ¼ãƒ ãƒ¼ãƒ³", "ç«ˆé–€ç‚­æ²»éƒ", "ç«ˆé–€ç¦°è±†å­", "æˆ‘å¦»å–„é€¸", "ç…‰ç„æå¯¿éƒ", "äº”æ¡æ‚Ÿ", "ã‚¢ãƒ¼ãƒ‹ãƒ£", "ã‚±ãƒ³ã‚·ãƒ­ã‚¦", "ç­‹è‚‰ãƒãƒ³", "ã‚´ã‚¸ãƒ©", "æ¡ƒå¤ªéƒ", "æµ¦å³¶å¤ªéƒ", "é‡‘å¤ªéƒ", "ã‹ãã‚„å§«", "ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©", "ç™½é›ªå§«", "ã‚¢ãƒªã‚¹", "ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ³", "ã¨ãªã‚Šã®ãƒˆãƒˆãƒ­", "åƒå°‹", "ã‚«ã‚ªãƒŠã‚·", "ãƒŠã‚¦ã‚·ã‚«", "ã‚­ã‚­", "ãƒãƒ­ãƒ¼ã‚­ãƒ†ã‚£", "ãƒŸãƒƒã‚­ãƒ¼ãƒã‚¦ã‚¹", "ã‚¹ãƒŒãƒ¼ãƒ”ãƒ¼", "åˆéŸ³ãƒŸã‚¯", "ãƒ’ã‚«ã‚­ãƒ³"]
        };

        document.addEventListener('DOMContentLoaded', () => {
            let roomCode = null;
            let playerToken = localStorage.getItem('buzzer_player_token');
            let displayName = null;
            let myScore = 0;
            let playerState = 'READY';
            let roomState = 'WAITING';
            let prevScore = 0;
            let wasWinner = false;

            const joinScreen = document.getElementById('joinScreen');
            const mainScreen = document.getElementById('mainScreen');
            const roomCodeSection = document.getElementById('roomCodeSection');
            const nameSection = document.getElementById('nameSection');
            const roomCodeInput = document.getElementById('roomCodeInput');
            const buzzerBtn = document.getElementById('buzzerBtn');

            // URLã‹ã‚‰ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) {
                roomCodeInput.value = roomFromUrl.toUpperCase();
            }

            roomCodeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });

            // ãƒ«ãƒ¼ãƒ ç¢ºèª
            document.getElementById('checkRoomBtn').addEventListener('click', async () => {
                roomCode = roomCodeInput.value.trim().toUpperCase();

                if (roomCode.length !== 6) {
                    alert('ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã¯6æ–‡å­—ã§ã™');
                    return;
                }

                try {
                    const roomData = await roomManager.joinRoom(roomCode);

                    if (playerToken && roomData.players && roomData.players[playerToken]) {
                        // æ—¢å­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦å†æ¥ç¶š
                        const player = await roomManager.addPlayer(playerToken, roomData.players[playerToken].displayName);
                        displayName = player.displayName;
                        myScore = player.score || 0;
                        enterGame();
                        return;
                    }

                    showNameSelection();
                } catch (error) {
                    alert('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            });

            function showNameSelection() {
                roomCodeSection.classList.add('hidden');
                nameSection.classList.remove('hidden');
                generateNameOptions();
            }

            function generateNameOptions() {
                const options = [];
                for (let i = 0; i < 5; i++) {
                    const modifier = namesData.modifiers[Math.floor(Math.random() * namesData.modifiers.length)];
                    const character = namesData.characters[Math.floor(Math.random() * namesData.characters.length)];
                    options.push(modifier + character);
                }

                const nameOptionsEl = document.getElementById('nameOptions');
                nameOptionsEl.innerHTML = options.map(name => `
                    <button class="name-option" data-name="${escapeHtml(name)}">${escapeHtml(name)}</button>
                `).join('');

                nameOptionsEl.querySelectorAll('.name-option').forEach(btn => {
                    btn.addEventListener('click', () => selectName(btn.dataset.name));
                });
            }

            document.getElementById('shuffleNamesBtn').addEventListener('click', generateNameOptions);

            async function selectName(name) {
                if (!confirm(`ã€Œ${name}ã€ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

                displayName = name;
                playerToken = generateToken();

                try {
                    const player = await roomManager.addPlayer(playerToken, displayName);
                    displayName = player.displayName;
                    myScore = player.score || 0;
                    localStorage.setItem('buzzer_player_token', playerToken);
                    enterGame();
                } catch (error) {
                    alert('å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            function enterGame() {
                joinScreen.classList.add('hidden');
                mainScreen.classList.remove('hidden');

                document.getElementById('myName').textContent = displayName;
                document.getElementById('myScore').textContent = myScore;

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
                roomManager.onRoomUpdate((room) => {
                    if (room) {
                        updateUI(room);
                    }
                });

                // åˆ‡æ–­æ™‚ã®å‡¦ç†
                window.addEventListener('beforeunload', () => {
                    if (playerToken) {
                        roomManager.disconnectPlayer(playerToken);
                    }
                });
            }

            // æ—©æŠ¼ã—ãƒœã‚¿ãƒ³
            buzzerBtn.addEventListener('click', async () => {
                if (buzzerBtn.disabled) return;
                if (playerState !== 'READY' || roomState !== 'OPEN') return;

                buzzerBtn.classList.add('pressed');
                playerState = 'PRESSED';
                updateBuzzerState();

                const result = await roomManager.buzz(playerToken);
                if (result.success && result.isWinner) {
                    buzzerBtn.classList.remove('pressed');
                    buzzerBtn.classList.add('winner');
                }
            });

            function updateUI(room) {
                const prevRoomState = roomState;
                roomState = room.roomState;
                document.getElementById('roundNumber').textContent = room.roundNumber || 1;

                const players = room.players || {};
                const me = players[playerToken];

                if (me) {
                    // ã‚¹ã‚³ã‚¢å¤‰åŒ–ã‚’ãƒã‚§ãƒƒã‚¯
                    const newScore = me.score || 0;
                    if (wasWinner && prevRoomState === 'LOCKED' && roomState === 'WAITING') {
                        // åˆ¤å®šçµæœãŒã‚ã£ãŸ
                        if (newScore > prevScore) {
                            showResult(true);
                        } else if (newScore < prevScore || (newScore === prevScore && room.roomState === 'OPEN')) {
                            showResult(false);
                        }
                    }

                    prevScore = myScore;
                    myScore = newScore;
                    document.getElementById('myScore').textContent = myScore;
                    playerState = me.playerState || 'READY';
                }

                // å‹è€…ãƒã‚§ãƒƒã‚¯
                wasWinner = room.winner && room.winner.playerToken === playerToken;

                if (roomState === 'OPEN' && prevRoomState !== 'OPEN') {
                    if (playerState === 'LOCKED_LOST' || playerState === 'PRESSED') {
                        playerState = 'READY';
                    }
                    buzzerBtn.classList.remove('pressed', 'winner', 'locked');
                } else if (roomState === 'WAITING' && prevRoomState !== 'WAITING') {
                    playerState = 'READY';
                    buzzerBtn.classList.remove('pressed', 'winner', 'locked');
                } else if (roomState === 'LOCKED') {
                    if (wasWinner) {
                        buzzerBtn.classList.add('winner');
                    } else if (playerState === 'READY') {
                        playerState = 'LOCKED_LOST';
                        buzzerBtn.classList.add('locked');
                    }
                }

                // çµ‚äº†ç”»é¢ã‚¯ãƒ©ã‚¹åˆ¶å¾¡
                if (roomState === 'FINISHED') {
                    document.getElementById('mainScreen').classList.add('game-finished');
                } else {
                    document.getElementById('mainScreen').classList.remove('game-finished');
                }

                updateBuzzerState();
                updateRanking(players);
            }

            function updateBuzzerState() {
                const statusText = document.getElementById('statusText');
                const buzzerText = document.getElementById('buzzerText');

                statusText.className = 'status-text';

                switch (roomState) {
                    case 'WAITING':
                        statusText.textContent = 'å¾…æ©Ÿä¸­...';
                        statusText.classList.add('status-waiting');
                        buzzerBtn.disabled = true;
                        buzzerText.textContent = 'WAIT';
                        break;
                    case 'OPEN':
                        if (playerState === 'READY') {
                            statusText.textContent = 'ğŸ”¥ æ—©æŠ¼ã—ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
                            statusText.classList.add('status-open');
                            buzzerBtn.disabled = false;
                            buzzerText.textContent = 'PUSH!';
                        } else if (playerState === 'LOCKED_PENALTY_THIS') {
                            statusText.textContent = 'ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­...';
                            statusText.classList.add('status-locked');
                            buzzerBtn.disabled = true;
                            buzzerText.textContent = 'ğŸš«';
                        } else {
                            statusText.textContent = 'æŠ¼ã—ã¾ã—ãŸï¼';
                            statusText.classList.add('status-pressed');
                            buzzerBtn.disabled = true;
                        }
                        break;
                    case 'LOCKED':
                        if (wasWinner) {
                            statusText.textContent = 'ğŸ‰ å…ˆç€ï¼åˆ¤å®šã‚’å¾…ã£ã¦ã„ã¾ã™...';
                            statusText.classList.add('status-winner');
                        } else {
                            statusText.textContent = 'ä»–ã®äººãŒå…ˆç€ã—ã¾ã—ãŸ';
                            statusText.classList.add('status-locked');
                        }
                        buzzerBtn.disabled = true;
                        break;
                    case 'FINISHED':
                        statusText.textContent = ''; // ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤º
                        buzzerBtn.disabled = true;
                        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒãƒ¡ã‚¤ãƒ³ã«ãªã‚‹ã®ã§ã“ã“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«
                        break;
                }
            }

            function updateRanking(players) {
                const list = document.getElementById('rankingList');
                const playerArray = Object.values(players);

                if (playerArray.length === 0) {
                    list.innerHTML = '<li class="text-muted">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
                    return;
                }

                const sorted = playerArray.sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 5);

                list.innerHTML = sorted.map((p, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    const highlight = p.displayName === displayName ? 'highlight' : '';

                    return `
                        <li class="ranking-item ${highlight}">
                            <span class="ranking-rank ${rankClass}">${i + 1}</span>
                            <span class="ranking-name">${escapeHtml(p.displayName)}</span>
                            <span class="ranking-score">${p.score || 0}pt</span>
                        </li>
                    `;
                }).join('');
            }

            function showResult(isCorrect) {
                const overlay = document.getElementById('resultOverlay');
                const content = document.getElementById('resultContent');
                const icon = document.getElementById('resultIcon');
                const text = document.getElementById('resultText');

                if (isCorrect) {
                    icon.textContent = 'â­•';
                    icon.style.color = 'var(--accent-green)';
                    text.textContent = 'æ­£è§£ï¼';
                    text.style.color = 'var(--accent-green)';
                } else {
                    icon.textContent = 'âŒ';
                    icon.style.color = 'var(--accent-red)';
                    text.textContent = 'ä¸æ­£è§£...';
                    text.style.color = 'var(--accent-red)';
                }

                overlay.classList.add('active');
                setTimeout(() => overlay.classList.remove('active'), 1500);
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // é€€å‡ºãƒœã‚¿ãƒ³
            document.getElementById('exitBtn').addEventListener('click', () => {
                if (confirm('æœ¬å½“ã«é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                    if (playerToken) {
                        roomManager.disconnectPlayer(playerToken);
                        // localStorage.removeItem('buzzer_player_token'); // ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ãã®ãŸã‚å‰Šé™¤ã—ãªã„
                    }
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>

</html>