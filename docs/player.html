<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéØ Êó©Êäº„Åó„ÇØ„Ç§„Ç∫ - „Éó„É¨„Ç§„É§„Éº</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        .player-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-name {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .my-score {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .buzzer-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
        }

        .status-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            min-height: 40px;
        }

        .status-waiting {
            color: var(--text-secondary);
        }

        .status-open {
            color: var(--accent-cyan);
            animation: blink 0.5s ease infinite;
        }

        .status-pressed {
            color: var(--accent-yellow);
        }

        .status-winner {
            color: var(--accent-green);
        }

        .status-locked {
            color: var(--accent-red);
        }

        .bottom-section {
            margin-top: auto;
        }

        .ranking-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .round-badge {
            background: var(--accent-purple);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .join-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .join-card {
            max-width: 500px;
            width: 100%;
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-content {
            text-align: center;
            animation: resultPop 0.5s ease;
        }

        @keyframes resultPop {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .result-icon {
            font-size: 8rem;
            margin-bottom: 16px;
        }

        .result-text {
            font-size: 2rem;
            font-weight: 700;
        }

        /* ÁµÇ‰∫ÜÁîªÈù¢Áî®„Çπ„Çø„Ç§„É´ */
        .game-finished .buzzer-area {
            display: none;
        }

        .game-finished .bottom-section {
            flex: 1;
            margin-top: 20px;
        }

        .game-finished .ranking-card {
            min-height: 60vh;
        }
    </style>
</head>

<body>
    <!-- ÂèÇÂä†ÁîªÈù¢ -->
    <div id="joinScreen" class="join-screen">
        <div class="card join-card text-center">
            <h1>üéÆ ÂèÇÂä†</h1>

            <div id="roomCodeSection">
                <p class="text-secondary mb-md">„É´„Éº„É†„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <div class="input-group">
                    <input type="text" class="input" id="roomCodeInput" placeholder="ROOM-CODE" maxlength="6"
                        style="text-align: center; font-size: 1.5rem; letter-spacing: 8px; text-transform: uppercase;">
                </div>
                <button class="btn btn-primary" id="checkRoomBtn">„É´„Éº„É†„ÇíÁ¢∫Ë™ç</button>
            </div>

            <div id="nameSection" class="hidden">
                <p class="text-secondary mb-md">ÂêçÂâç„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
                <div id="nameOptions" class="name-options"></div>
                <button class="btn btn-secondary mt-md" id="shuffleNamesBtn">
                    üîÑ ‰ªñ„ÅÆÂêçÂâç„ÇíË¶ã„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- „Éó„É¨„Ç§„É§„Éº„É°„Ç§„É≥ÁîªÈù¢ -->
    <div id="mainScreen" class="player-container hidden">
        <header class="player-header">
            <div class="player-info">
                <span class="player-name" id="myDisplayName">Guest</span>
                <span class="player-role">PLAYER</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- ÂïèÈ°åÊï∞Ë°®Á§∫ -->
                <span id="playerRoundNum"
                    style="font-weight: bold; color: var(--accent-cyan); margin-right: 5px;">Á¨¨1Âïè</span>
                <div class="my-score"><span id="myScore">0</span>pt</div>
            </div>
            <button id="exitBtn" class="btn btn-small btn-secondary" style="margin-left: 8px;">ÈÄÄÂá∫</button>
        </header>

        <div class="buzzer-area">
            <h2 class="hidden" id="finishText"
                style="color: var(--accent-cyan); font-size: 2.5rem; margin-bottom: 20px;">„ÇØ„Ç§„Ç∫ÁµÇ‰∫ÜÔºÅ</h2>
            <div class="status-text" id="statusText">Êé•Á∂ö‰∏≠...</div>
            <button class="buzzer-btn" id="buzzerBtn" disabled>
                <span id="buzzerText">PUSH!</span>
            </button>
        </div>

        <div class="bottom-section">
            <div class="ranking-card">
                <div class="ranking-header">
                    <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
                    <span class="round-badge">Á¨¨<span id="roundNumber">1</span>Âïè</span>
                </div>
                <ul class="ranking-list" id="rankingList">
                    <li class="text-muted">„É©„É≥„Ç≠„É≥„Ç∞Ë™≠„ÅøËæº„Åø‰∏≠...</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ÁµêÊûú„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="resultOverlay" class="result-overlay">
        <div class="result-content" id="resultContent">
            <div class="result-icon" id="resultIcon">‚≠ï</div>
            <div class="result-text" id="resultText">Ê≠£Ëß£ÔºÅ</div>
        </div>
    </div>

    <script src="js/firebase-app.js"></script>
    <script>
        // ÂêçÂâçÂÄôË£ú„Éá„Éº„Çø
        const namesData = {
            modifiers: ["‰ºùË™¨„ÅÆ", "Èóá„Çà„ÇäÂá∫„Åß„Åó", "‰∏ñÁïå„ÇíÊïë„ÅÜ", "„É¨„Éô„É´99„ÅÆ", "Ë¶öÈÜí„Åó„Åü", "ÈäÄÊ≤≥ÊúÄÂº∑„ÅÆ", "Â∞ÅÂç∞„Åï„Çå„Åó", "1000Âπ¥„Å´‰∏Ä‰∫∫„ÅÆ", "Â•áË∑°„ÅÆ", "Êö¥Ëµ∞„Åô„Çã", "Á•û„Å´ÈÅ∏„Å∞„Çå„Åü", "ÊºÜÈªí„ÅÆÁøº„ÇíÊåÅ„Å§", "ÂÖ®ÂÆáÂÆô„ÅÆ", "ÊúÄÁµÇÂΩ¢ÊÖã„ÅÆ", "ÂøÖÊÆ∫ÊäÄ„ÇíÊîæ„Å§", "ÈôêÁïåÁ™ÅÁ†¥„Åó„Åü", "Èü≥ÈÄü„ÅÆ", "ÊôÇ„Çí„Åã„Åë„Çã", "Êú™Êù•„Åã„ÇâÊù•„Åü", "Ë¨é„ÅÆÁµÑÁπî„ÅÆ", "ÁÇé„Çí„Åæ„Å®„ÅÜ", "Ê∞∑„ÅÆÂøÉ„ÇíÊåÅ„Å§", "ÁÑ°Êïµ„ÅÆ", "ÈªÑÈáë„ÅÆ", "Âæ©ËÆê„ÇíË™ì„ÅÜ", "Ê∞∏ÈÅ†„ÅÆ", "Âπª„ÅÆ", "Ë¶áÁéãËâ≤„ÅÆ", "ÊÆãÂÉè„ÅåË¶ã„Åà„Çã", "„Çπ„Éº„Éë„Éº", "„É°„Ç¨ÈÄ≤Âåñ", "Â∑®Â§ßÂåñ„Åó„Åü", "Âú∞ÁçÑ„Åã„Çâ„ÅÆ‰ΩøËÄÖ", "Á©∫„ÇíÈ£õ„Å∂", "ÈÄèÊòé‰∫∫Èñì„ÅÆ", "ÈãºÈâÑ„ÅÆ", "ÂÆøÈ°å„ÇíÂøò„Çå„Åü", "Áµ¶È£üÂΩìÁï™„ÅÆ", "Âªä‰∏ã„Å´Á´ã„Åü„Åï„Çå„Åü", "„ÉÜ„Çπ„Éà0ÁÇπ„ÅÆ", "„ÉÜ„Çπ„Éà100ÁÇπ„ÅÆ", "Â§è‰ºë„Åø‰∏≠„ÅÆ", "Â±ÖÊÆã„Çä„Åï„Åõ„Çâ„Çå„Åü", "ÊîæÈÄÅÂßîÂì°„ÅÆ", "Âõ≥Êõ∏ÂÆ§„ÅÆ‰∏ª", "‰øùÂÅ•ÂÆ§„ÅßÂØù„Å¶„ÅÑ„Çã", "ÈÅãÂãï‰ºö„ÅßËª¢„Çì„Å†", "Á¥ÖÁôΩÂ∏Ω„Çí„Åã„Å∂„Å£„Åü", "‰∏äÂ±•„Åç„ÇíÂøò„Çå„Åü", "„Éó„Éº„É´„ÅåË¶ãÂ≠¶„ÅÆ", "Ê†°Èï∑ÂÖàÁîü„ÅÆ", "ÈÅ†Ë∂≥„ÅÆ„Åä„ÇÑ„Å§„ÇíÊåÅ„Å£„Åü", "„ÇØ„É©„Çπ„ÅÆ‰∫∫Ê∞óËÄÖ", "Â≠¶Á¥öÂßîÂì°Èï∑", "ÁîüÂæí‰ºöÈï∑", "ÈÉ®Ê¥ª„Çí„Çµ„Éú„Å£„Åü", "ÂÖàÁîü„Å´ÊÄí„Çâ„Çå„Åü", "ÂØùÂùä„Åó„Åü", "ÂØùÁôñ„Åå„Å≤„Å©„ÅÑ", "„Ç≤„Éº„É†Á¶ÅÊ≠¢‰∏≠„ÅÆ", "„Çπ„Éû„ÉõÊ≤°Âèé„Åï„Çå„Åü", "Wi-Fi„ÇíÊé¢„Åó„Å¶„ÅÑ„Çã", "Á≠ãËÇâÁóõ„ÅÆ", "Ëá™Áß∞„Ç§„Ç±„É°„É≥„ÅÆ", "„Åô„ÅêÊ≥£„Åè", "ÊñπÂêëÈü≥Áó¥„ÅÆ", "Èü≥Áó¥„Å™", "ÈáéÁîü„ÅÆ", "„Éö„ÉÉ„Éà„ÅÆ", "Áå´ËÄ≥„ÅÆ", "„Ç¥„É™„É©„Å£„ÅΩ„ÅÑ", "AIÊê≠Ëºâ„ÅÆ", "YouTuber„ÅÆ", "„Éó„É≠„Ç≤„Éº„Éû„Éº", "Ë™≤ÈáëÂã¢„ÅÆ", "Ê≠£Áæ©„ÅÆ", "ÊÇ™„ÅÆ", "ËøëÊâÄ„ÅÆ", "Ë¨é„ÅÆ", "Âàù‰ª£", "ÂÖÉÁ•ñ", "„Éã„Çª„É¢„Éé„ÅÆ", "ÈáèÁî£Âûã", "„Ç≠„É©„Ç≠„É©„ÅÆ", "Êó•Êú¨‰ª£Ë°®", "‰∏ñÁïå„É©„É≥„ÇØ1‰Ωç„ÅÆ", "ÊåáÂêçÊâãÈÖç‰∏≠„ÅÆ", "ËÑ±Ëµ∞‰∏≠„ÅÆ", "ÂÆáÂÆô‰∫∫"],
            characters: ["ÁπîÁî∞‰ø°Èï∑", "Ë±äËá£ÁßÄÂêâ", "Âæ≥Â∑ùÂÆ∂Â∫∑", "ÂùÇÊú¨ÈæçÈ¶¨", "Ë•øÈÉ∑ÈöÜÁõõ", "ËÅñÂæ≥Â§™Â≠ê", "ÂçëÂº•Âëº", "Ê∫êÈ†ºÊúù", "Ê∫êÁæ©Áµå", "Ê≠¶Áî∞‰ø°ÁéÑ", "‰∏äÊùâË¨ô‰ø°", "‰ºäÈÅîÊîøÂÆó", "ÁúüÁî∞Âπ∏Êùë", "ÂçÉÂà©‰ºë", "ÊùæÂ∞æËä≠Ëïâ", "Á¥´ÂºèÈÉ®", "Ê∏ÖÂ∞ëÁ¥çË®Ä", "Á¶èÊ≤¢Ë´≠Âêâ", "ÈáéÂè£Ëã±‰∏ñ", "Â§èÁõÆÊº±Áü≥", "ÂÆÆÊ≤¢Ë≥¢Ê≤ª", "ÂúüÊñπÊ≠≥‰∏â", "ÊúçÈÉ®ÂçäËîµ", "ËëõÈ£æÂåóÊñé", "‰∏Ä‰ºë„Åï„Çì", "Ê∞¥Êà∏ÈªÑÈñÄ", "„Éä„Éù„É¨„Ç™„É≥", "„Ç®„Ç∏„ÇΩ„É≥", "„Ç¢„Ç§„É≥„Ç∑„É•„Çø„Ç§„É≥", "„Éã„É•„Éº„Éà„É≥", "„Éô„Éº„Éà„Éº„É¥„Çß„É≥", "„É¢„Éº„ÉÑ„Ç°„É´„Éà", "Ë´∏ËëõÂ≠îÊòé", "„ÇØ„É¨„Ç™„Éë„Éà„É©", "„É™„É≥„Ç´„Éº„É≥", "„Ç¨„É≥„Ç∏„Éº", "„Ç≥„É≠„É≥„Éñ„Çπ", "„Ç≠„É•„É™„ÉºÂ§´‰∫∫", "„É¨„Ç™„Éä„É´„Éâ„Éª„ÉÄ„Éª„É¥„Ç£„É≥„ÉÅ", "„Éî„Ç´„ÇΩ", "„Ç¥„ÉÉ„Éõ", "„ÉÄ„Éº„Ç¶„Ç£„É≥", "„Ç∏„É£„É≥„Éå„Éª„ÉÄ„É´„ÇØ", "„Ç¶„Ç©„É´„Éà„Éª„Éá„Ç£„Ç∫„Éã„Éº", "„Çπ„ÉÜ„Ç£„Éº„Éñ„Éª„Ç∏„Éß„Éñ„Ç∫", "„Éâ„É©„Åà„ÇÇ„Çì", "„ÅÆ„Å≥Â§™", "„Ç∏„É£„Ç§„Ç¢„É≥", "„Çπ„ÉçÂ§´", "„Åó„Åö„Åã„Å°„ÇÉ„Çì", "„Éî„Ç´„ÉÅ„É•„Ç¶", "„Çµ„Éà„Ç∑", "„Éû„É™„Ç™", "„É´„Ç§„Éº„Ç∏", "„ÇØ„ÉÉ„Éë", "Êòü„ÅÆ„Ç´„Éº„Éì„Ç£", "„Ç¢„É≥„Éë„É≥„Éû„É≥", "„Éê„Ç§„Ç≠„É≥„Éû„É≥", "Â≠´ÊÇüÁ©∫", "„Éô„Ç∏„Éº„Çø", "„Éï„É™„Éº„Ç∂", "„É´„Éï„Ç£", "„Çæ„É≠", "„Éä„Éü", "„ÉÅ„Éß„ÉÉ„Éë„Éº", "Ê±üÊà∏Â∑ù„Ç≥„Éä„É≥", "ÊÄ™Áõó„Ç≠„ÉÉ„Éâ", "ÈáéÂéü„Åó„Çì„ÅÆ„Åô„Åë", "‰∏°Ê¥•ÂãòÂêâ", "„Çª„Éº„É©„Éº„É†„Éº„É≥", "Á´àÈñÄÁÇ≠Ê≤ªÈÉé", "Á´àÈñÄÁ¶∞Ë±ÜÂ≠ê", "ÊàëÂ¶ªÂñÑÈÄ∏", "ÁÖâÁçÑÊùèÂØøÈÉé", "‰∫îÊù°ÊÇü", "„Ç¢„Éº„Éã„É£", "„Ç±„É≥„Ç∑„É≠„Ç¶", "Á≠ãËÇâ„Éû„É≥", "„Ç¥„Ç∏„É©", "Ê°ÉÂ§™ÈÉé", "Êµ¶Â≥∂Â§™ÈÉé", "ÈáëÂ§™ÈÉé", "„Åã„Åê„ÇÑÂß´", "„Ç∑„É≥„Éá„É¨„É©", "ÁôΩÈõ™Âß´", "„Ç¢„É™„Çπ", "„Éî„Éº„Çø„Éº„Éë„É≥", "„Å®„Å™„Çä„ÅÆ„Éà„Éà„É≠", "ÂçÉÂ∞ã", "„Ç´„Ç™„Éä„Ç∑", "„Éä„Ç¶„Ç∑„Ç´", "„Ç≠„Ç≠", "„Éè„É≠„Éº„Ç≠„ÉÜ„Ç£", "„Éü„ÉÉ„Ç≠„Éº„Éû„Ç¶„Çπ", "„Çπ„Éå„Éº„Éî„Éº", "ÂàùÈü≥„Éü„ÇØ", "„Éí„Ç´„Ç≠„É≥"]
        };

        document.addEventListener('DOMContentLoaded', () => {
            let roomCode = null;
            let playerToken = localStorage.getItem('buzzer_player_token');
            let displayName = null;
            let myScore = 0;
            let playerState = 'READY';
            let roomState = 'WAITING';
            let prevScore = 0;
            let wasWinner = false;

            const joinScreen = document.getElementById('joinScreen');
            const mainScreen = document.getElementById('mainScreen');
            const roomCodeSection = document.getElementById('roomCodeSection');
            const nameSection = document.getElementById('nameSection');
            const roomCodeInput = document.getElementById('roomCodeInput');
            const buzzerBtn = document.getElementById('buzzerBtn');

            // URL„Åã„Çâ„É´„Éº„É†„Ç≥„Éº„ÉâÂèñÂæó
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) {
                roomCodeInput.value = roomFromUrl.toUpperCase();
            }

            roomCodeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });

            // „É´„Éº„É†Á¢∫Ë™ç
            document.getElementById('checkRoomBtn').addEventListener('click', async () => {
                roomCode = roomCodeInput.value.trim().toUpperCase();

                if (roomCode.length !== 6) {
                    alert('„É´„Éº„É†„Ç≥„Éº„Éâ„ÅØ6ÊñáÂ≠ó„Åß„Åô');
                    return;
                }

                try {
                    const roomData = await roomManager.joinRoom(roomCode);

                    if (playerToken && roomData.players && roomData.players[playerToken]) {
                        // Êó¢Â≠ò„Éó„É¨„Ç§„É§„Éº„Å®„Åó„Å¶ÂÜçÊé•Á∂ö
                        const player = await roomManager.addPlayer(playerToken, roomData.players[playerToken].displayName);
                        displayName = player.displayName;
                        myScore = player.score || 0;
                        enterGame();
                        return;
                    }

                    showNameSelection();
                } catch (error) {
                    alert('„É´„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
            });

            function showNameSelection() {
                roomCodeSection.classList.add('hidden');
                nameSection.classList.remove('hidden');
                generateNameOptions();
            }

            function generateNameOptions() {
                const options = [];
                for (let i = 0; i < 5; i++) {
                    const modifier = namesData.modifiers[Math.floor(Math.random() * namesData.modifiers.length)];
                    const character = namesData.characters[Math.floor(Math.random() * namesData.characters.length)];
                    options.push(modifier + character);
                }

                const nameOptionsEl = document.getElementById('nameOptions');
                nameOptionsEl.innerHTML = options.map(name => `
                    <button class="name-option" data-name="${escapeHtml(name)}">${escapeHtml(name)}</button>
                `).join('');

                nameOptionsEl.querySelectorAll('.name-option').forEach(btn => {
                    btn.addEventListener('click', () => selectName(btn.dataset.name));
                });
            }

            document.getElementById('shuffleNamesBtn').addEventListener('click', generateNameOptions);

            async function selectName(name) {
                if (!confirm(`„Äå${name}„Äç„Åß„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) return;

                displayName = name;
                playerToken = generateToken();

                try {
                    const player = await roomManager.addPlayer(playerToken, displayName);
                    displayName = player.displayName;
                    myScore = player.score || 0;
                    localStorage.setItem('buzzer_player_token', playerToken);
                    enterGame();
                } catch (error) {
                    alert('ÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }

            function enterGame() {
                joinScreen.classList.add('hidden');
                mainScreen.classList.remove('hidden');

                document.getElementById('myDisplayName').textContent = displayName; // Changed from myName to myDisplayName
                document.getElementById('myScore').textContent = myScore;

                // „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñÈñãÂßã
                roomManager.onRoomUpdate((room) => {
                    if (room) {
                        updateUI(room);
                    }
                });

                // ÂàáÊñ≠ÊôÇ„ÅÆÂá¶ÁêÜ
                window.addEventListener('beforeunload', () => {
                    if (playerToken) {
                        roomManager.disconnectPlayer(playerToken);
                    }
                });
            }

            // Êó©Êäº„Åó„Éú„Çø„É≥
            buzzerBtn.addEventListener('click', async () => {
                if (buzzerBtn.disabled) return;
                if (playerState !== 'READY' || roomState !== 'OPEN') return;

                buzzerBtn.classList.add('pressed');
                playerState = 'PRESSED';
                updateBuzzerState();

                const result = await roomManager.buzz(playerToken);
                if (result.success && result.isWinner) {
                    buzzerBtn.classList.remove('pressed');
                    buzzerBtn.classList.add('winner');
                }
            });

            function updateUI(room) {
                const prevRoomState = roomState;
                roomState = room.roomState;
                document.getElementById('roundNumber').textContent = room.roundNumber || 1;

                const players = room.players || {};
                const me = players[playerToken];

                if (me) {
                    // „Çπ„Ç≥„Ç¢Â§âÂåñ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const newScore = me.score || 0;
                    if (wasWinner && prevRoomState === 'LOCKED' && roomState === 'WAITING') {
                        // Âà§ÂÆöÁµêÊûú„Åå„ÅÇ„Å£„Åü
                        if (newScore > prevScore) {
                            showResult(true);
                        } else if (newScore < prevScore || (newScore === prevScore && room.roomState === 'OPEN')) {
                            showResult(false);
                        }
                    }

                    prevScore = myScore;
                    myScore = newScore;
                    document.getElementById('myScore').textContent = me.score || 0;
                    document.getElementById('playerRoundNum').textContent = `Á¨¨${room.roundNumber || 1}Âïè`;
                    playerState = me.playerState || 'READY';
                }

                // ÂãùËÄÖ„ÉÅ„Çß„ÉÉ„ÇØ
                wasWinner = room.winner && room.winner.playerToken === playerToken;

                if (roomState === 'OPEN' && prevRoomState !== 'OPEN') {
                    if (playerState === 'LOCKED_LOST' || playerState === 'PRESSED') {
                        playerState = 'READY';
                    }
                    buzzerBtn.classList.remove('pressed', 'winner', 'locked');
                } else if (roomState === 'WAITING' && prevRoomState !== 'WAITING') {
                    playerState = 'READY';
                    buzzerBtn.classList.remove('pressed', 'winner', 'locked');
                } else if (roomState === 'LOCKED') {
                    if (wasWinner) {
                        buzzerBtn.classList.add('winner');
                    } else if (playerState === 'READY') {
                        playerState = 'LOCKED_LOST';
                        buzzerBtn.classList.add('locked');
                    }
                }

                // ÁµÇ‰∫ÜÁîªÈù¢„ÇØ„É©„ÇπÂà∂Âæ°
                if (roomState === 'FINISHED') {
                    document.getElementById('mainScreen').classList.add('game-finished');
                    const ft = document.getElementById('finishText');
                    if (ft) ft.classList.remove('hidden');
                } else {
                    document.getElementById('mainScreen').classList.remove('game-finished');
                    const ft = document.getElementById('finishText');
                    if (ft) ft.classList.add('hidden');
                }

                updateBuzzerState();
                updateRanking(players);
            }

            function updateBuzzerState() {
                const statusText = document.getElementById('statusText');
                const buzzerText = document.getElementById('buzzerText');

                statusText.className = 'status-text';

                switch (roomState) {
                    case 'WAITING':
                        statusText.textContent = 'ÂæÖÊ©ü‰∏≠...';
                        statusText.classList.add('status-waiting');
                        buzzerBtn.disabled = true;
                        buzzerText.textContent = 'WAIT';
                        break;
                    case 'OPEN':
                        if (playerState === 'READY') {
                            statusText.textContent = 'üî• Êó©Êäº„Åó„Çπ„Çø„Éº„ÉàÔºÅ';
                            statusText.classList.add('status-open');
                            buzzerBtn.disabled = false;
                            buzzerText.textContent = 'PUSH!';
                        } else if (playerState === 'LOCKED_PENALTY_THIS') {
                            statusText.textContent = '„Éö„Éä„É´„ÉÜ„Ç£‰∏≠...';
                            statusText.classList.add('status-locked');
                            buzzerBtn.disabled = true;
                            buzzerText.textContent = 'üö´';
                        } else {
                            statusText.textContent = 'Êäº„Åó„Åæ„Åó„ÅüÔºÅ';
                            statusText.classList.add('status-pressed');
                            buzzerBtn.disabled = true;
                        }
                        break;
                    case 'LOCKED':
                        if (wasWinner) {
                            statusText.textContent = 'üéâ ÂÖàÁùÄÔºÅÂà§ÂÆö„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...';
                            statusText.classList.add('status-winner');
                        } else {
                            statusText.textContent = '‰ªñ„ÅÆ‰∫∫„ÅåÂÖàÁùÄ„Åó„Åæ„Åó„Åü';
                            statusText.classList.add('status-locked');
                        }
                        buzzerBtn.disabled = true;
                        break;
                    case 'FINISHED':
                        statusText.textContent = ''; // „ÉÜ„Ç≠„Çπ„ÉàÈùûË°®Á§∫
                        buzzerBtn.disabled = true;
                        // „É©„É≥„Ç≠„É≥„Ç∞„Åå„É°„Ç§„É≥„Å´„Å™„Çã„ÅÆ„Åß„Åì„Åì„ÅØ„Ç∑„É≥„Éó„É´„Å´
                        break;
                }
            }

            function updateRanking(players) {
                const list = document.getElementById('rankingList');
                const playerArray = Object.values(players);

                if (playerArray.length === 0) {
                    list.innerHTML = '<li class="text-muted">„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</li>';
                    return;
                }

                const sorted = playerArray.sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 5);

                list.innerHTML = sorted.map((p, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    const highlight = p.displayName === displayName ? 'highlight' : '';

                    return `
                        <li class="ranking-item ${highlight}">
                            <span class="ranking-rank ${rankClass}">${i + 1}</span>
                            <span class="ranking-name">${escapeHtml(p.displayName)}</span>
                            <span class="ranking-score">${p.score || 0}pt</span>
                        </li>
                    `;
                }).join('');
            }

            function showResult(isCorrect) {
                const overlay = document.getElementById('resultOverlay');
                const content = document.getElementById('resultContent');
                const icon = document.getElementById('resultIcon');
                const text = document.getElementById('resultText');

                if (isCorrect) {
                    icon.textContent = '‚≠ï';
                    icon.style.color = 'var(--accent-green)';
                    text.textContent = 'Ê≠£Ëß£ÔºÅ';
                    text.style.color = 'var(--accent-green)';
                } else {
                    icon.textContent = '‚ùå';
                    icon.style.color = 'var(--accent-red)';
                    text.textContent = '‰∏çÊ≠£Ëß£...';
                    text.style.color = 'var(--accent-red)';
                }

                overlay.classList.add('active');
                setTimeout(() => overlay.classList.remove('active'), 1500);
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // ÈÄÄÂá∫„Éú„Çø„É≥
            document.getElementById('exitBtn').addEventListener('click', () => {
                if (confirm('Êú¨ÂΩì„Å´ÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                    if (playerToken) {
                        roomManager.disconnectPlayer(playerToken);
                    }
                    window.location.href = 'index.html';
                }
            });

            // „Éê„Éº„Ç∏„Éß„É≥Ë°®Á§∫
            const vEl = document.createElement('div');
            vEl.style.position = 'fixed';
            vEl.style.bottom = '10px';
            vEl.style.right = '10px';
            vEl.style.color = 'rgba(255,255,255,0.3)';
            vEl.style.fontSize = '0.8rem';
            vEl.textContent = 'v1.2.4';
            document.body.appendChild(vEl);
        });
    </script>
</body>

</html>