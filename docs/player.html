<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¯ æ—©æŠ¼ã—ã‚¯ã‚¤ã‚º - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        .player-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-name {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .my-score {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .buzzer-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
        }

        .status-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            min-height: 40px;
        }

        .status-waiting {
            color: var(--text-secondary);
        }

        .status-open {
            color: var(--accent-cyan);
            animation: blink 0.5s ease infinite;
        }

        .status-pressed {
            color: var(--accent-yellow);
        }

        .status-winner {
            color: var(--accent-green);
        }

        .status-locked {
            color: var(--accent-red);
        }

        .bottom-section {
            margin-top: auto;
        }

        .ranking-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .round-badge {
            background: var(--accent-purple);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .join-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .join-card {
            max-width: 500px;
            width: 100%;
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-content {
            text-align: center;
            animation: resultPop 0.5s ease;
        }

        @keyframes resultPop {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .result-icon {
            font-size: 8rem;
            margin-bottom: 16px;
        }

        .result-text {
            font-size: 2rem;
            font-weight: 700;
        }

        /* çµ‚äº†ç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .game-finished .buzzer-area {
            display: none;
        }

        .game-finished .bottom-section {
            flex: 1;
            margin-top: 20px;
        }

        .game-finished .ranking-card {
            min-height: 60vh;
        }
    </style>
</head>

<body>
    <!-- å‚åŠ ç”»é¢ -->
    <div id="joinScreen" class="join-screen">
        <div class="card join-card text-center">
            <h1>ğŸ® å‚åŠ </h1>

            <div id="roomCodeSection">
                <p class="text-secondary mb-md">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <div class="input-group">
                    <input type="text" class="input" id="roomCodeInput" placeholder="ROOM-CODE" maxlength="6"
                        style="text-align: center; font-size: 1.5rem; letter-spacing: 8px; text-transform: uppercase;">
                </div>
                <button class="btn btn-primary" id="checkRoomBtn">ãƒ«ãƒ¼ãƒ ã‚’ç¢ºèª</button>
            </div>

            <div id="nameSection" class="hidden">
                <p class="text-secondary mb-md">åå‰ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div id="nameOptions" class="name-options"></div>
                <button class="btn btn-secondary mt-md" id="shuffleNamesBtn">
                    ğŸ”„ ä»–ã®åå‰ã‚’è¦‹ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="player-container hidden">
        <header class="player-header">
            <div class="player-info">
                <span class="player-name" id="myDisplayName">Guest</span>
                <span class="player-role">PLAYER</span>
                <span class="team-badge hidden" id="myTeamBadge"></span>
            </div>
            <div class="score-stack">
                <!-- å•é¡Œæ•°è¡¨ç¤º -->
                <span id="playerRoundNum"
                    style="font-weight: bold; color: var(--accent-cyan); margin-right: 5px;">ç¬¬1å•</span>
                <div class="team-score-block hidden" id="teamScoreBlock">
                    <span class="team-name" id="myTeamName"></span>
                    <span class="team-score"><span id="teamScore">0</span>pt</span>
                </div>
                <div class="my-score" id="soloScoreBlock"><span id="myScore">0</span>pt</div>
                <div class="individual-score hidden" id="individualScoreBlock">å€‹äºº <span id="myIndividualScore">0</span>pt</div>
            </div>
            <button id="exitBtn" class="btn btn-small btn-secondary" style="margin-left: 8px;">é€€å‡º</button>
        </header>

        <div class="buzzer-area">
            <h2 class="hidden" id="finishText"
                style="color: var(--accent-cyan); font-size: 2.5rem; margin-bottom: 20px;">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
            <div class="status-text" id="statusText">æ¥ç¶šä¸­...</div>
            <button class="buzzer-btn" id="buzzerBtn" disabled>
                <span id="buzzerText">PUSH!</span>
            </button>
        </div>

        <div class="bottom-section">
            <div class="ranking-card">
                <div class="ranking-header">
                    <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <span class="round-badge">ç¬¬<span id="roundNumber">1</span>å•</span>
                </div>
                <div class="ranking-columns">
                    <div class="ranking-block">
                        <h4>ãƒãƒ¼ãƒ </h4>
                        <ul class="ranking-list" id="teamRankingList">
                            <li class="text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ä¸­...</li>
                        </ul>
                    </div>
                    <div class="ranking-block">
                        <h4>å€‹äºº</h4>
                        <ul class="ranking-list" id="rankingList">
                            <li class="text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª­ã¿è¾¼ã¿ä¸­...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="resultOverlay" class="result-overlay">
        <div class="result-content" id="resultContent">
            <div class="result-icon" id="resultIcon">â­•</div>
            <div class="result-text" id="resultText">æ­£è§£ï¼</div>
        </div>
    </div>

    <script src="js/firebase-app.js"></script>
    <script>
        // åå‰å€™è£œãƒ‡ãƒ¼ã‚¿ã¯fetchã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™
        let namesData = null;

        document.addEventListener('DOMContentLoaded', async () => {
            let roomCode = null;
            let playerToken = localStorage.getItem('buzzer_player_token');
            let displayName = null;
            let myScore = 0;
            let myTeamScore = 0;
            let playerState = 'READY';
            let roomState = 'WAITING';
            let prevScore = 0;
            let wasWinner = false;

            const joinScreen = document.getElementById('joinScreen');
            const mainScreen = document.getElementById('mainScreen');
            const roomCodeSection = document.getElementById('roomCodeSection');
            const nameSection = document.getElementById('nameSection');
            const roomCodeInput = document.getElementById('roomCodeInput');
            const buzzerBtn = document.getElementById('buzzerBtn');

            // åå‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            try {
                const response = await fetch('/data/names.json');
                namesData = await response.json();
            } catch (e) {
                console.error('Failed to load names data:', e);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ç©ºã®ãƒ‡ãƒ¼ã‚¿
                namesData = { modifiers: [''], characters: ['Unknown'] };
            }

            // URLã‹ã‚‰ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            if (roomFromUrl) {
                roomCodeInput.value = roomFromUrl.toUpperCase();
            }

            roomCodeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });

            // roomManagerãŒå®šç¾©ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã—ã¦ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            const setupRoomManager = () => {
                if (typeof roomManager === 'undefined') {
                    setTimeout(setupRoomManager, 100);
                    return;
                }

                // ãƒ«ãƒ¼ãƒ ç¢ºèª
                document.getElementById('checkRoomBtn').addEventListener('click', async () => {
                    roomCode = roomCodeInput.value.trim().toUpperCase();

                if (roomCode.length !== 6) {
                    alert('ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã¯6æ–‡å­—ã§ã™');
                    return;
                }

                try {
                    const roomData = await roomManager.joinRoom(roomCode);

                    if (playerToken && roomData.players && roomData.players[playerToken]) {
                        // æ—¢å­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦å†æ¥ç¶š
                        const player = await roomManager.addPlayer(playerToken, roomData.players[playerToken].displayName);
                        displayName = player.displayName;
                        myScore = player.individualScore !== undefined ? player.individualScore : (player.score || 0);
                        enterGame();
                        return;
                    }

                    showNameSelection();
                } catch (error) {
                    alert('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                });

                function showNameSelection() {
                    roomCodeSection.classList.add('hidden');
                    nameSection.classList.remove('hidden');
                    
                    // namesData ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤
                    if (!namesData || !namesData.modifiers) {
                        const checkInterval = setInterval(() => {
                            if (namesData && namesData.modifiers) {
                                clearInterval(checkInterval);
                                generateNameOptions();
                            }
                        }, 100);
                        
                        // 5ç§’å¾…ã£ã¦ã‚‚ãƒ€ãƒ¡ãªã‚‰å¼·åˆ¶çš„ã«å®Ÿè¡Œ
                        setTimeout(() => {
                            clearInterval(checkInterval);
                            generateNameOptions();
                        }, 5000);
                    } else {
                        generateNameOptions();
                    }
                }

                function generateNameOptions() {
                    if (!namesData || !namesData.modifiers || !namesData.characters) {
                        document.getElementById('nameOptions').innerHTML = '<p>åå‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                        return;
                    }

                    const options = [];
                    for (let i = 0; i < 5; i++) {
                        const modifier = namesData.modifiers[Math.floor(Math.random() * namesData.modifiers.length)];
                        const character = namesData.characters[Math.floor(Math.random() * namesData.characters.length)];
                        options.push(modifier + character);
                    }

                    const nameOptionsEl = document.getElementById('nameOptions');
                    nameOptionsEl.innerHTML = options.map(name => `
                        <button class="name-option" data-name="${escapeHtml(name)}">${escapeHtml(name)}</button>
                    `).join('');

                    nameOptionsEl.querySelectorAll('.name-option').forEach(btn => {
                        btn.addEventListener('click', () => selectName(btn.dataset.name));
                    });
                }

                document.getElementById('shuffleNamesBtn').addEventListener('click', generateNameOptions);

                async function selectName(name) {
                    if (!confirm(`ã€Œ${name}ã€ã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

                    displayName = name;
                    playerToken = generateToken();

                    try {
                        const player = await roomManager.addPlayer(playerToken, displayName);
                        displayName = player.displayName;
                        myScore = player.individualScore !== undefined ? player.individualScore : (player.score || 0);
                        localStorage.setItem('buzzer_player_token', playerToken);
                        enterGame();
                    } catch (error) {
                        alert('å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            };

            // setupRoomManager() ã‚’å‘¼ã³å‡ºã—ã¦ã€roomManager ãŒå®šç¾©ã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
            setupRoomManager();

            function enterGame() {
                joinScreen.classList.add('hidden');
                mainScreen.classList.remove('hidden');

                document.getElementById('myDisplayName').textContent = displayName; // Changed from myName to myDisplayName
                document.getElementById('myScore').textContent = myScore;
                document.getElementById('myIndividualScore').textContent = myScore;

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
                roomManager.onRoomUpdate((room) => {
                    if (room) {
                        updateUI(room);
                    }
                });

                // åˆ‡æ–­æ™‚ã®å‡¦ç†
                window.addEventListener('beforeunload', () => {
                    if (playerToken) {
                        roomManager.disconnectPlayer(playerToken);
                    }
                });

                // æ—©æŠ¼ã—ãƒœã‚¿ãƒ³
                buzzerBtn.addEventListener('click', async () => {
                    if (buzzerBtn.disabled) return;
                    if (playerState !== 'READY' || roomState !== 'OPEN') return;

                    buzzerBtn.classList.add('pressed');
                    playerState = 'PRESSED';
                    updateBuzzerState();

                    const result = await roomManager.buzz(playerToken);
                    if (result.success && result.isWinner) {
                        buzzerBtn.classList.remove('pressed');
                        buzzerBtn.classList.add('winner');
                    }
                });
            }

            function updateUI(room) {
                const prevRoomState = roomState;
                roomState = room.roomState;
                document.getElementById('roundNumber').textContent = room.roundNumber || 1;

                const players = room.players || {};
                const me = players[playerToken];
                const teamMode = room.rules && room.rules.teamMode;

                if (me) {
                    // ã‚¹ã‚³ã‚¢å¤‰åŒ–ã‚’ãƒã‚§ãƒƒã‚¯
                    const newScore = teamMode
                        ? (me.individualScore !== undefined ? me.individualScore : (me.score || 0))
                        : (me.score || 0);
                    if (wasWinner && prevRoomState === 'LOCKED' && roomState === 'WAITING') {
                        // åˆ¤å®šçµæœãŒã‚ã£ãŸ
                        if (newScore > prevScore) {
                            showResult(true);
                        } else if (newScore < prevScore || (newScore === prevScore && room.roomState === 'OPEN')) {
                            showResult(false);
                        }
                    }

                    prevScore = myScore;
                    myScore = newScore;
                    document.getElementById('myScore').textContent = myScore;
                    document.getElementById('myIndividualScore').textContent = myScore;
                    document.getElementById('playerRoundNum').textContent = `ç¬¬${room.roundNumber || 1}å•`;
                    playerState = me.playerState || 'READY';
                }

                const teamScoreBlock = document.getElementById('teamScoreBlock');
                const individualScoreBlock = document.getElementById('individualScoreBlock');
                const soloScoreBlock = document.getElementById('soloScoreBlock');
                const myTeamBadge = document.getElementById('myTeamBadge');
                const myTeamName = document.getElementById('myTeamName');

                if (teamMode && me && me.teamId && room.teams && room.teams[me.teamId]) {
                    const team = room.teams[me.teamId];
                    myTeamScore = team.score || 0;
                    document.getElementById('teamScore').textContent = myTeamScore;
                    if (myTeamName) {
                        myTeamName.textContent = team.teamName || 'ãƒãƒ¼ãƒ ';
                        myTeamName.style.color = team.color || 'var(--accent-cyan)';
                    }
                    if (myTeamBadge) {
                        myTeamBadge.textContent = team.teamName || 'ãƒãƒ¼ãƒ ';
                        myTeamBadge.style.background = team.color || 'var(--accent-cyan)';
                        myTeamBadge.classList.remove('hidden');
                    }
                    if (teamScoreBlock) {
                        teamScoreBlock.style.border = `1px solid ${team.color || 'var(--accent-cyan)'}`;
                    }
                    if (teamScoreBlock) teamScoreBlock.classList.remove('hidden');
                    if (individualScoreBlock) individualScoreBlock.classList.remove('hidden');
                    if (soloScoreBlock) soloScoreBlock.classList.add('hidden');
                } else {
                    if (myTeamBadge) myTeamBadge.classList.add('hidden');
                    if (teamScoreBlock) teamScoreBlock.classList.add('hidden');
                    if (individualScoreBlock) individualScoreBlock.classList.add('hidden');
                    if (soloScoreBlock) soloScoreBlock.classList.remove('hidden');
                }

                // å‹è€…ãƒã‚§ãƒƒã‚¯
                wasWinner = room.winner && room.winner.playerToken === playerToken;

                if (roomState === 'OPEN' && prevRoomState !== 'OPEN') {
                    if (playerState === 'LOCKED_LOST' || playerState === 'PRESSED') {
                        playerState = 'READY';
                    }
                    buzzerBtn.classList.remove('pressed', 'winner', 'locked');
                } else if (roomState === 'WAITING' && prevRoomState !== 'WAITING') {
                    playerState = 'READY';
                    buzzerBtn.classList.remove('pressed', 'winner', 'locked');
                } else if (roomState === 'LOCKED') {
                    if (wasWinner) {
                        buzzerBtn.classList.add('winner');
                    } else if (playerState === 'READY') {
                        playerState = 'LOCKED_LOST';
                        buzzerBtn.classList.add('locked');
                    }
                }

                // çµ‚äº†ç”»é¢ã‚¯ãƒ©ã‚¹åˆ¶å¾¡
                if (roomState === 'FINISHED') {
                    document.getElementById('mainScreen').classList.add('game-finished');
                    const ft = document.getElementById('finishText');
                    if (ft) ft.classList.remove('hidden');
                } else {
                    document.getElementById('mainScreen').classList.remove('game-finished');
                    const ft = document.getElementById('finishText');
                    if (ft) ft.classList.add('hidden');
                }

                updateBuzzerState();
                updateRanking(players, room.teams || {}, room.rules || {});
            }

            function updateBuzzerState() {
                const statusText = document.getElementById('statusText');
                const buzzerText = document.getElementById('buzzerText');

                statusText.className = 'status-text';

                switch (roomState) {
                    case 'WAITING':
                        statusText.textContent = 'å¾…æ©Ÿä¸­...';
                        statusText.classList.add('status-waiting');
                        buzzerBtn.disabled = true;
                        buzzerText.textContent = 'WAIT';
                        break;
                    case 'OPEN':
                        if (playerState === 'READY') {
                            statusText.textContent = 'ğŸ”¥ æ—©æŠ¼ã—ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
                            statusText.classList.add('status-open');
                            buzzerBtn.disabled = false;
                            buzzerText.textContent = 'PUSH!';
                        } else if (playerState === 'LOCKED_PENALTY_THIS') {
                            statusText.textContent = 'ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­...';
                            statusText.classList.add('status-locked');
                            buzzerBtn.disabled = true;
                            buzzerText.textContent = 'ğŸš«';
                        } else {
                            statusText.textContent = 'æŠ¼ã—ã¾ã—ãŸï¼';
                            statusText.classList.add('status-pressed');
                            buzzerBtn.disabled = true;
                        }
                        break;
                    case 'LOCKED':
                        if (wasWinner) {
                            statusText.textContent = 'ğŸ‰ å…ˆç€ï¼åˆ¤å®šã‚’å¾…ã£ã¦ã„ã¾ã™...';
                            statusText.classList.add('status-winner');
                        } else {
                            statusText.textContent = 'ä»–ã®äººãŒå…ˆç€ã—ã¾ã—ãŸ';
                            statusText.classList.add('status-locked');
                        }
                        buzzerBtn.disabled = true;
                        break;
                    case 'FINISHED':
                        statusText.textContent = ''; // ãƒ†ã‚­ã‚¹ãƒˆéè¡¨ç¤º
                        buzzerBtn.disabled = true;
                        buzzerBtn.classList.add('hidden'); // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒãƒ¡ã‚¤ãƒ³ã«ãªã‚‹ã®ã§ã“ã“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«
                        break;
                }
            }

            function updateRanking(players, teams, rules) {
                const list = document.getElementById('rankingList');
                const teamList = document.getElementById('teamRankingList');
                const playerArray = Object.values(players);

                if (playerArray.length === 0) {
                    list.innerHTML = '<li class="text-muted">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
                    if (teamList) teamList.innerHTML = '<li class="text-muted">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
                    return;
                }

                const sorted = playerArray.sort((a, b) => {
                    const aScore = a.individualScore !== undefined ? a.individualScore : (a.score || 0);
                    const bScore = b.individualScore !== undefined ? b.individualScore : (b.score || 0);
                    return bScore - aScore;
                }).slice(0, 5);

                list.innerHTML = sorted.map((p, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    const highlight = p.displayName === displayName ? 'highlight' : '';
                    const score = p.individualScore !== undefined ? p.individualScore : (p.score || 0);

                    return `
                        <li class="ranking-item ${highlight}">
                            <span class="ranking-rank ${rankClass}">${i + 1}</span>
                            <span class="ranking-name">${escapeHtml(p.displayName)}</span>
                            <span class="ranking-score">${score}pt</span>
                        </li>
                    `;
                }).join('');

                const teamArray = Object.values(teams || {});
                if (rules.teamMode && teamList && teamArray.length > 0) {
                    const teamSorted = teamArray.sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 5);
                    teamList.innerHTML = teamSorted.map((team, i) => {
                        const fallbackTokens = Object.values(players)
                            .filter(p => p.teamId === team.teamId)
                            .map(p => p.playerToken);
                        const memberTokens = (team.members && team.members.length > 0) ? team.members : fallbackTokens;
                        const members = memberTokens.map(token => players[token]).filter(Boolean).sort((a, b) => {
                                const aScore = a.individualScore !== undefined ? a.individualScore : (a.score || 0);
                                const bScore = b.individualScore !== undefined ? b.individualScore : (b.score || 0);
                                return bScore - aScore;
                            });
                        const memberList = members.map(p => {
                            const score = p.individualScore !== undefined ? p.individualScore : (p.score || 0);
                            return `<span class="team-member-chip">${escapeHtml(p.displayName)} ${score}pt</span>`;
                        }).join('');
                        const teamName = escapeHtml(team.teamName || 'ãƒãƒ¼ãƒ ');
                        const teamColor = team.color || 'var(--accent-cyan)';
                        return `
                            <li class="ranking-item team-ranking-item">
                                <div class="team-ranking-header" style="--team-color: ${teamColor};">
                                    <span class="ranking-rank">${i + 1}</span>
                                    <span class="team-name">${teamName}</span>
                                    <span class="team-score">${team.score || 0}pt</span>
                                </div>
                                <div class="team-member-chips">${memberList || '<span class="text-muted">ãƒ¡ãƒ³ãƒãƒ¼ãªã—</span>'}</div>
                            </li>
                        `;
                    }).join('');
                } else if (teamList) {
                    teamList.innerHTML = rules.teamMode
                        ? '<li class="text-muted">ãƒãƒ¼ãƒ æœªä½œæˆã§ã™</li>'
                        : '<li class="text-muted">ãƒãƒ¼ãƒ æˆ¦ãªã—</li>';
                }
            }

            function showResult(isCorrect) {
                const overlay = document.getElementById('resultOverlay');
                const content = document.getElementById('resultContent');
                const icon = document.getElementById('resultIcon');
                const text = document.getElementById('resultText');

                if (isCorrect) {
                    icon.textContent = 'â­•';
                    icon.style.color = 'var(--accent-green)';
                    text.textContent = 'æ­£è§£ï¼';
                    text.style.color = 'var(--accent-green)';
                } else {
                    icon.textContent = 'âŒ';
                    icon.style.color = 'var(--accent-red)';
                    text.textContent = 'ä¸æ­£è§£...';
                    text.style.color = 'var(--accent-red)';
                }

                overlay.classList.add('active');
                setTimeout(() => overlay.classList.remove('active'), 1500);
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // é€€å‡ºãƒœã‚¿ãƒ³
            document.getElementById('exitBtn').addEventListener('click', () => {
                if (confirm('æœ¬å½“ã«é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                    if (playerToken) {
                        roomManager.disconnectPlayer(playerToken);
                    }
                    window.location.href = 'index.html';
                }
            });

            // Version display
            const vEl = document.createElement('div');
            vEl.style.position = 'fixed';
            vEl.style.bottom = '10px';
            vEl.style.right = '10px';
            vEl.style.color = 'rgba(255,255,255,0.3)';
            vEl.style.fontSize = '0.8rem';
            vEl.textContent = window.APP_VERSION || 'v1.6.1';
            document.body.appendChild(vEl);

        });
    </script>
</body>

</html>
