<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¯ æ—©æŠ¼ã—ã‚¯ã‚¤ã‚º - ãƒ›ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        .host-container {
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .control-center {
            text-align: center;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .judge-buttons {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
        }

        .judge-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setup-card {
            max-width: 500px;
            width: 100%;
        }

        .share-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 600px) {
            .share-section {
                grid-template-columns: 1fr;
            }
        }

        .player-grid {
            display: grid;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
    <div id="setupScreen" class="setup-screen">
        <div class="card setup-card text-center">
            <h1>ğŸ‘‘ ãƒ›ã‚¹ãƒˆè¨­å®š</h1>

            <!-- é¸æŠç”»é¢ -->
            <div id="choiceSection">
                <p class="text-secondary mb-lg">ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ ã®è¨­å®šã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div class="control-buttons" style="flex-direction: column; gap: 16px;">
                    <button class="btn btn-primary btn-large" id="showCreateBtn" style="width: 100%;">
                        ğŸ“ æ–°ã—ããƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹
                    </button>
                    <button class="btn btn-secondary btn-large" id="showResumeBtn" style="width: 100%;">
                        ğŸ”„ ãƒ«ãƒ¼ãƒ ã‚’å†é–‹ã™ã‚‹
                    </button>
                    <button class="btn btn-secondary" onclick="location.href='index.html'" style="width: 100%;">
                        ğŸ  TOPã¸æˆ»ã‚‹
                    </button>
                </div>
            </div> <!-- choiceSection end -->

            <!-- ãƒ«ãƒ¼ãƒ ä½œæˆå‰ -->
            <div id="createSection" class="hidden">
                <h3 class="mb-md">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</h3>
                <p class="text-secondary mb-lg">æ–°ã—ã„6æ¡ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã™</p>
                <div class="control-buttons">
                    <button class="btn btn-secondary" id="backToChoiceBtn1">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="createRoomBtn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ å†é–‹ -->
            <div id="resumeSection" class="hidden">
                <h3 class="mb-md">ãƒ«ãƒ¼ãƒ å†é–‹</h3>
                <div class="input-group text-left" style="margin-bottom: 16px;">
                    <label>ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ (6æ¡)</label>
                    <input type="text" class="input" id="resumeRoomCode" placeholder="123456" maxlength="6"
                        pattern="[0-9]{6}">
                </div>
                <div class="input-group text-left">
                    <label>ãƒ›ã‚¹ãƒˆPIN (4æ¡)</label>
                    <input type="text" class="input" id="resumePin" placeholder="XXXX" maxlength="4" pattern="[0-9]{4}">
                </div>
                <div class="control-buttons mt-lg">
                    <button class="btn btn-secondary" id="backToChoiceBtn2">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="resumeRoomBtn">å†é–‹ã™ã‚‹</button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ ä½œæˆå¾Œ -->
            <div id="roomCreatedSection" class="hidden">
                <p class="text-secondary mb-md" id="roomCreatedMsg">ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼</p>

                <div class="room-code" id="displayRoomCode"></div>

                <div class="mt-lg">
                    <p class="text-muted mb-sm">å‚åŠ URL</p>
                    <div id="qrcode" style="display: flex; justify-content: center; margin-bottom: 20px;"></div>
                    <input type="text" class="input" id="shareUrl" readonly style="text-align: center;">
                    <button class="btn btn-small btn-secondary mt-sm" id="copyUrlBtn">
                        ğŸ“‹ ã‚³ãƒ”ãƒ¼
                    </button>
                </div>

                <div class="mt-lg" id="pinDisplaySection">
                    <p class="text-muted mb-sm">ãƒ›ã‚¹ãƒˆPINï¼ˆãƒ¡ãƒ¢ã—ã¦ãã ã•ã„ï¼‰</p>
                    <div class="room-code" id="displayPin" style="font-size: 2rem;"></div>
                </div>

                <div class="mt-lg">
                    <button class="btn btn-primary btn-large" id="autoJoinBtn">
                        ğŸš€ ãƒ›ã‚¹ãƒˆã¨ã—ã¦é–‹å§‹
                    </button>
                    <button class="btn btn-secondary mt-md" id="settingsTogglePre" style="width: 100%;">
                        âš™ï¸ ãƒ«ãƒ¼ãƒ«è¨­å®š
                    </button>
                    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ä½ç½®å¤‰æ›´ -->
                    <button class="btn btn-small btn-secondary mt-md" id="backToChoiceFromCreated"
                        style="width: 100%;">æˆ»ã‚‹</button>
                </div>
            </div>
        </div> <!-- card end -->
    </div> <!-- setupScreen end -->

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="host-container hidden">
        <header class="header">
            <div class="room-info">
                <div class="info-item">
                    <span class="info-label">ãƒ«ãƒ¼ãƒ </span>
                    <span class="info-value" id="headerRoomCode">---</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ãƒ›ã‚¹ãƒˆPIN</span>
                    <span class="info-value" id="headerPin" style="color: var(--accent-purple);">----</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å‚åŠ è€…</span>
                    <span class="info-value"><span id="playerCount">0</span>äºº</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ãƒ©ã‚¦ãƒ³ãƒ‰</span>
                    <span class="info-value">#<span id="roundNumber">1</span></span>
                </div>
                <div id="roomStateBadge" class="badge badge-waiting">WAITING</div>
            </div>
            <button id="backToSetupBtn" class="btn btn-small btn-secondary">æˆ»ã‚‹</button>
        </header>

        <div class="main-grid">
            <div class="card control-center">
                <!-- å•é¡Œæ•°è¡¨ç¤º -->
                <div class="text-center mb-lg">
                    <h2 style="font-size: 2.5rem; color: var(--accent-cyan); margin: 0;">ç¬¬<span
                            id="roundNumberDisplay">1</span>å•</h2>
                </div>

                <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆçµ‚äº†æ™‚ã«è¡¨ç¤ºï¼‰ -->
                <div id="finalRankingSection" class="hidden">
                    <h3 class="text-center text-accent mb-md">ğŸ† æœ€çµ‚çµæœ ğŸ†</h3>
                    <ul class="ranking-list" id="hostRankingList"></ul>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
                <div id="controlSection">
                    <!-- å…ˆç€è€…è¡¨ç¤º -->
                    <div id="winnerDisplay" class="winner-display hidden mt-lg">
                        <p class="text-muted">å…ˆç€</p>
                        <div class="winner-name" id="winnerName">---</div>
                        <div class="winner-time"><span id="reactionTime">0</span> ms</div>
                    </div>

                    <!-- å¾…æ©Ÿæ™‚è¡¨ç¤º -->
                    <div id="waitingDisplay" class="mt-lg">
                        <p class="text-secondary" style="font-size: 1.2rem;">å‚åŠ è€…ãŒæƒã£ãŸã‚‰ã€ã€Œã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—ï¼</p>
                    </div>

                    <!-- åˆ¤å®šãƒœã‚¿ãƒ³ -->
                    <div id="judgeButtons" class="judge-buttons hidden">
                        <button class="btn btn-success judge-btn" id="correctBtn">â—‹</button>
                        <button class="btn btn-danger judge-btn" id="wrongBtn">Ã—</button>
                    </div>

                    <!-- é€²è¡Œãƒœã‚¿ãƒ³ -->
                    <div class="control-buttons">
                        <button class="btn btn-primary btn-large" id="openBtn">
                            ğŸ”“ å›ç­”å†é–‹ (Open)
                        </button>
                        <button class="btn btn-secondary btn-large" id="nextBtn">
                            â¡ï¸ æ¬¡ã®å•é¡Œã¸
                        </button>
                    </div>

                    <!-- Undoãƒœã‚¿ãƒ³è¿½åŠ  -->
                    <div class="mt-md">
                        <button id="undoBtn" class="btn btn-small btn-secondary hidden" style="width: 100%;">
                            â†©ï¸ å‰ã«æˆ»ã™ (Undo)
                        </button>
                    </div>

                    <!-- çµ‚äº†ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                    <div class="mt-lg pt-md" style="border-top: 1px solid var(--border-color);">
                        <button id="finishGameBtn" class="btn btn-danger" style="width: 100%;">
                            ğŸ ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã—ã¦çµæœç™ºè¡¨
                        </button>
                    </div>
                </div><!-- /controlSection -->
            </div>

            <div class="card">
                <h3 class="mb-md">å‚åŠ è€…ä¸€è¦§ (<span id="playerListCount">0</span>äºº)</h3>
                <div id="playerList" class="player-grid">
                    <p class="text-muted">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>

        <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
        <button class="btn btn-icon btn-secondary settings-toggle" id="settingsToggle">
            âš™ï¸
        </button>
    </div>

    <!-- è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="settingsOverlay" class="settings-overlay">
        <div class="settings-modal">
            <div class="flex-between mb-lg">
                <h2>âš™ï¸ ãƒ«ãƒ¼ãƒ«è¨­å®š</h2>
                <button class="btn btn-small btn-secondary" id="closeSettings">âœ• é–‰ã˜ã‚‹</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">èª¤ç­”ãƒšãƒŠãƒ«ãƒ†ã‚£</span>
                <div class="setting-options">
                    <button class="setting-option" data-setting="penaltyType" data-value="none">ãªã—</button>
                    <button class="setting-option active" data-setting="penaltyType"
                        data-value="thisRound">å½“å•ãƒ­ãƒƒã‚¯</button>
                    <button class="setting-option" data-setting="penaltyType" data-value="nextRound">æ¬¡å•ã‚‚ãƒ­ãƒƒã‚¯</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">æ­£è§£åŠ ç‚¹</span>
                <div class="setting-options">
                    <button class="setting-option" data-setting="correctPoints" data-value="0">ãªã—</button>
                    <button class="setting-option active" data-setting="correctPoints" data-value="1">+1</button>
                    <button class="setting-option" data-setting="correctPoints" data-value="2">+2</button>
                    <button class="setting-option" data-setting="correctPoints" data-value="3">+3</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">èª¤ç­”æ¸›ç‚¹</span>
                <div class="setting-options">
                    <button class="setting-option active" data-setting="wrongPoints" data-value="0">ãªã—</button>
                    <button class="setting-option" data-setting="wrongPoints" data-value="1">-1</button>
                    <button class="setting-option" data-setting="wrongPoints" data-value="2">-2</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">å¾—ç‚¹ä¸‹é™</span>
                <div class="setting-options">
                    <button class="setting-option active" data-setting="allowNegative" data-value="false">0ã¾ã§</button>
                    <button class="setting-option" data-setting="allowNegative" data-value="true">ãƒã‚¤ãƒŠã‚¹ã‚ã‚Š</button>
                </div>
            </div>

        </div>
    </div>
    <!-- èª¤ç­”å¾Œã®å‡¦ç†ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰Šé™¤ -->
    </div>
    </div>

    <script src="js/firebase-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let roomCode = null;
            let currentRules = {};
            let previousState = null; // å‰å›ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ä¿æŒ

            const setupScreen = document.getElementById('setupScreen');
            const mainScreen = document.getElementById('mainScreen');
            const createSection = document.getElementById('createSection');
            const roomCreatedSection = document.getElementById('roomCreatedSection');
            const choiceSection = document.getElementById('choiceSection');
            const resumeSection = document.getElementById('resumeSection');

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('showCreateBtn').onclick = () => {
                choiceSection.classList.add('hidden');
                createSection.classList.remove('hidden');
            };

            document.getElementById('showResumeBtn').onclick = () => {
                choiceSection.classList.add('hidden');
                resumeSection.classList.remove('hidden');
            };

            document.getElementById('backToChoiceBtn1').onclick = () => {
                createSection.classList.add('hidden');
                choiceSection.classList.remove('hidden');
            };

            document.getElementById('backToChoiceBtn2').onclick = () => {
                resumeSection.classList.add('hidden');
                choiceSection.classList.remove('hidden');
            };

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ï¼ˆå†é–‹ãƒ¢ãƒ¼ãƒ‰ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');

            if (roomFromUrl) {
                // URLã«ãƒ«ãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆã¯å†é–‹ãƒ¢ãƒ¼ãƒ‰ã¸ç›´è¡Œ
                choiceSection.classList.add('hidden');
                resumeSection.classList.remove('hidden');
                document.getElementById('resumeRoomCode').value = roomFromUrl;
            }

            document.getElementById('createRoomBtn').addEventListener('click', async () => {
                try {
                    const result = await roomManager.createRoom();
                    roomCode = result.roomCode;

                    document.getElementById('displayRoomCode').textContent = roomCode;
                    document.getElementById('displayPin').textContent = result.pin;

                    // URLæ›´æ–°
                    const newUrl = `${window.location.pathname}?room=${roomCode}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);

                    const shareUrl = `${window.location.origin}${window.location.pathname.replace('host.html', '')}player.html?room=${roomCode}`;
                    document.getElementById('shareUrl').value = shareUrl;

                    // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById('qrcode'), {
                        text: shareUrl,
                        width: 150,
                        height: 150,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    // PINè¡¨ç¤º
                    document.getElementById('roomCreatedMsg').style.display = 'block';
                    document.getElementById('pinDisplaySection').style.display = 'block';

                    // è‡ªå‹•å‚åŠ ãƒœã‚¿ãƒ³
                    document.getElementById('autoJoinBtn').onclick = async () => {
                        await enterHostMode(roomCode, result.pin);
                    };

                    createSection.classList.add('hidden');
                    roomCreatedSection.classList.remove('hidden');

                    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ (Generated Screen)
                    document.getElementById('backToChoiceFromCreated').onclick = () => {
                        roomCreatedSection.classList.add('hidden');
                        setupScreen.classList.remove('hidden');
                        // ãƒ«ãƒ¼ãƒ ä½œæˆãƒ•ãƒ­ãƒ¼ã«æˆ»ã‚‹ãªã‚‰: setupScreen > choiceSectionè¡¨ç¤ºã¸
                        choiceSection.classList.remove('hidden');
                        createSection.classList.add('hidden');
                    };

                } catch (error) {
                    console.error('âŒ createRoom error:', error);
                    alert('ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });

            async function enterHostMode(code, pin) {
                try {
                    await roomManager.joinRoom(code); // RoomRefåˆæœŸåŒ–ã®ãŸã‚ã«å¿…é ˆ
                    const valid = await roomManager.verifyPin(code, pin);
                    if (valid) {
                        setupScreen.classList.add('hidden');
                        mainScreen.classList.remove('hidden');
                        document.getElementById('headerRoomCode').textContent = code;
                        document.getElementById('headerPin').textContent = pin;
                        roomCode = code;

                        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ (Main Screen)
                        document.getElementById('backToSetupBtn').onclick = () => {
                            mainScreen.classList.add('hidden');
                            if (document.getElementById('roomCreatedSection').style.display !== 'none' || document.getElementById('shareUrl').value) {
                                // æ–°è¦ä½œæˆç›´å¾Œãªã‚‰Createdã¸
                                setupScreen.classList.remove('hidden');
                                roomCreatedSection.classList.remove('hidden');
                            } else {
                                // å†é–‹ãªã‚‰å†é–‹ç”»é¢ã¸ï¼Ÿ
                                // ã¨ã‚Šã‚ãˆãšã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒˆãƒƒãƒ—ã¸æˆ»ã™
                                setupScreen.classList.remove('hidden');
                                choiceSection.classList.remove('hidden');
                                resumeSection.classList.add('hidden');
                            }
                        };

                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
                        roomManager.onRoomUpdate((room) => {
                            if (room) {
                                updateUI(room);
                            }
                        });
                    } else {
                        alert('PINãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }
                } catch (error) {
                    alert('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            // URLã‚³ãƒ”ãƒ¼
            document.getElementById('copyUrlBtn').addEventListener('click', () => {
                const urlInput = document.getElementById('shareUrl');
                urlInput.select();
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    document.getElementById('copyUrlBtn').textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                    setTimeout(() => {
                        document.getElementById('copyUrlBtn').textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    }, 2000);
                });
            });

            // å†é–‹å®Ÿè¡Œ
            document.getElementById('resumeRoomBtn').onclick = async () => {
                const code = document.getElementById('resumeRoomCode').value;
                const pin = document.getElementById('resumePin').value;
                if (!code || !pin) {
                    alert('ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã¨PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                await enterHostMode(code, pin);
            };

            // è§£æ”¾
            document.getElementById('openBtn').addEventListener('click', async () => {
                playSound('open');
                await roomManager.openBuzz();
            });

            // æ­£è§£
            document.getElementById('correctBtn').addEventListener('click', async () => {
                playSound('correct');
                await roomManager.judge('correct');

                // è‡ªå‹•é€²è¡Œ: å»ƒæ­¢ï¼ˆæ‰‹å‹•ã®ã¿ï¼‰
            });

            // èª¤ç­”
            document.getElementById('wrongBtn').addEventListener('click', async () => {
                playSound('wrong');
                await roomManager.judge('wrong');

                // è‡ªå‹•å†é–‹: 0.5ç§’å¾Œã«Open (ãƒšãƒŠãƒ«ãƒ†ã‚£ç­™æŒ)
                setTimeout(async () => {
                    await roomManager.openBuzz(false); // forceClearPenalty=false
                }, 500);
            });

            // æ¬¡ã¸
            document.getElementById('nextBtn').addEventListener('click', async () => {
                playSound('open');
                await roomManager.nextRound();
            });

            // Undo (ä¸€æ‰‹æˆ»ã™)
            document.getElementById('undoBtn').addEventListener('click', async () => {
                if (confirm('åˆ¤å®šã‚’ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚¹ã‚³ã‚¢ã‚„çŠ¶æ…‹ãŒåˆ¤å®šå‰ã«æˆ»ã‚Šã¾ã™ï¼‰')) {
                    await roomManager.restoreBackup();
                }
            });

            // è¨­å®šãƒˆã‚°ãƒ«
            document.getElementById('settingsToggle').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.add('active');
            });

            document.getElementById('closeSettings').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.remove('active');
            });

            // æº–å‚™ç”»é¢ã®è¨­å®šãƒœã‚¿ãƒ³
            document.getElementById('settingsTogglePre').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.add('active');
            });

            // çµ‚äº†ãƒœã‚¿ãƒ³
            document.getElementById('finishGameBtn').addEventListener('click', async () => {
                if (confirm('ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nå‚åŠ è€…ã«çµæœç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚')) {
                    await roomManager.finishGame();
                }
            });

            // è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
            document.querySelectorAll('.setting-option').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const setting = btn.dataset.setting;
                    let value = btn.dataset.value;

                    if (value === 'true') value = true;
                    else if (value === 'false') value = false;
                    else if (!isNaN(value)) value = parseInt(value);

                    btn.parentElement.querySelectorAll('.setting-option').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    await roomManager.updateRules({ [setting]: value });
                });
            });

            // UIæ›´æ–°
            function updateUI(room) {
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„å…±é€šè¡¨ç¤º
                const rNum = room.roundNumber || 1;
                document.getElementById('roundNumber').textContent = rNum;

                // å•é¡Œæ•°è¡¨ç¤ºæ›´æ–° (ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢)
                const rDisp = document.getElementById('roundNumberDisplay');
                if (rDisp) rDisp.textContent = rNum;

                // å‚åŠ è€…äººæ•° (ãƒªã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼)
                const pCount = Object.keys(room.players || {}).length;
                document.getElementById('playerListCount').textContent = pCount;

                currentRules = room.rules || {};

                const badge = document.getElementById('roomStateBadge');
                const openBtn = document.getElementById('openBtn');
                const nextBtn = document.getElementById('nextBtn');
                const judgeButtons = document.getElementById('judgeButtons');
                const winnerDisplay = document.getElementById('winnerDisplay');
                const waitingDisplay = document.getElementById('waitingDisplay');
                const controlSection = document.getElementById('controlSection');
                const finalRankingSection = document.getElementById('finalRankingSection');

                // çµ‚äº†çŠ¶æ…‹
                if (room.roomState === 'FINISHED') {
                    if (controlSection) controlSection.classList.add('hidden');
                    if (finalRankingSection) finalRankingSection.classList.remove('hidden');
                    badge.classList.add('badge-locked');
                    badge.textContent = 'FINISHED';

                    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆ (ç•¥: å¤‰æ›´ãªã—)
                    // ... (å‰ã®ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾)
                    const pList = Object.values(room.players || {});
                    const sorted = pList.sort((a, b) => (b.score || 0) - (a.score || 0));
                    const listEl = document.getElementById('hostRankingList');
                    if (listEl) {
                        listEl.innerHTML = sorted.map((p, i) => `
                            <li class="ranking-item ${i === 0 ? 'highlight' : ''}" style="margin-bottom: 8px; padding: 12px; background: var(--bg-card); border-radius: 8px; display: flex; justify-content: space-between;">
                                <span class="ranking-rank" style="font-weight: bold; font-size: 1.2rem; min-width: 30px;">${i + 1}.</span>
                                <span class="ranking-name" style="flex: 1; margin-left: 10px;">${escapeHtml(p.displayName)}</span>
                                <span class="ranking-score" style="font-weight: bold; color: var(--accent-cyan);">${p.score || 0}pt</span>
                            </li>
                        `).join('');
                    }

                    // éŸ³å†ç”Ÿ (ä¸€åº¦ã ã‘é³´ã‚‰ã™)
                    if (previousState !== 'FINISHED') {
                        playSound('end');
                    }
                    previousState = room.roomState;
                    updatePlayerList(room.players || {});
                    return;
                }

                // é€šå¸¸çŠ¶æ…‹
                if (controlSection) controlSection.classList.remove('hidden');
                if (finalRankingSection) finalRankingSection.classList.add('hidden');

                // Openãƒœã‚¿ãƒ³æ–‡è¨€ & è¡¨ç¤ºåˆ¶å¾¡
                // ãƒ«ãƒ¼ãƒ«:
                // 1. OPENä¸­ã¯éè¡¨ç¤º (å›ç­”å—ä»˜ä¸­ã ã‹ã‚‰)
                // 2. LOCKEDã§æ­£è§£è€…(winner)ãŒã„ã‚‹å ´åˆã¯éè¡¨ç¤º (æ¬¡ã¸é€²ã‚€ã¹ãã ã‹ã‚‰)
                // 3. LOCKEDã§æ­£è§£è€…ãŒãŠã‚‰ãšã€ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã®äººãŒã„ã‚‹å ´åˆã¯è¡¨ç¤º (å…¨å“¡è§£é™¤ã®ãŸã‚)
                // 4. WAITINGã¯è¡¨ç¤º (ã‚¹ã‚¿ãƒ¼ãƒˆç”¨)

                let showOpenBtn = false;
                const pVals = Object.values(room.players || {});
                const hasPenalty = pVals.some(p =>
                    p.playerState === 'LOCKED_PENALTY_THIS' || p.playerState === 'LOCKED_PENALTY_NEXT'
                );

                if (room.roomState === 'WAITING') {
                    // æ­£è§£(winner)ãŒå‡ºãŸå¾Œã¯ canAdvance=trueã€‚ãã®é–“ã¯ãƒœã‚¿ãƒ³ä¸è¦ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
                    // ãŸã ã—ã€ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯è¡¨ç¤ºï¼ˆè§£é™¤ã®ãŸã‚ï¼‰
                    showOpenBtn = !room.canAdvance || hasPenalty;
                } else if (room.roomState === 'LOCKED') {
                    if (room.winner) {
                        showOpenBtn = false;
                    } else {
                        // å›ç­”è€…ãŒã„ãªã„ãƒ­ãƒƒã‚¯çŠ¶æ…‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç­‰ï¼‰ã‚„ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã¯è¡¨ç¤º
                        showOpenBtn = true;
                    }
                } else if (room.roomState === 'OPEN') {
                    // å›ç­”å—ä»˜ä¸­ã€‚èª°ã‹ãŒãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã®å ´åˆã¯ã€Œè§£é™¤ã€ãƒœã‚¿ãƒ³ã¨ã—ã¦å‡ºã™
                    showOpenBtn = hasPenalty;
                }

                if (showOpenBtn) {
                    openBtn.classList.remove('hidden');
                } else {
                    openBtn.classList.add('hidden');
                }

                // openBtn ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‹•çš„ã«è¨­å®š
                const isFirstWait = (rNum === 1) && room.roomState === 'WAITING' && !room.openTimestamp;
                if (isFirstWait) {
                    openBtn.textContent = 'ğŸš€ ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆï¼';
                } else if (hasPenalty && room.roomState !== 'OPEN') {
                    // ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã§ OPEN ã§ãªã„å ´åˆã¯ã€Œå…¨å“¡ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤ã€
                    openBtn.textContent = 'ğŸ”“ å…¨å“¡ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤';
                } else {
                    openBtn.textContent = 'ğŸ”“ å›ç­”å†é–‹';
                }

                if (isFirstWait) {
                    waitingDisplay.innerHTML = '<p class="text-secondary" style="font-size: 1.2rem;">å‚åŠ è€…ãŒæƒã£ãŸã‚‰ã€ã€Œã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’ã‚¿ãƒƒãƒ—ï¼</p>';
                } else if (room.roomState === 'OPEN') {
                    // å›ç­”å—ä»˜ä¸­
                    waitingDisplay.innerHTML = '<p class="text-success" style="font-size: 1.2rem;">ğŸ”¹ å›ç­”å—ä»˜ä¸­... ï¼ˆãƒœã‚¿ãƒ³ã‚’é€£æ‰“ã§ãã¾ã™ï¼ï¼‰</p>';
                } else if (room.canAdvance) {
                    // æ­£è§£(ã¾ãŸã¯èª¤ç­”)å¾Œã« canAdvance=true ã«ãªã£ãŸéš›ã€‚
                    waitingDisplay.innerHTML = '<p class="text-accent" style="font-size: 1.2rem;">æ­£è§£ï¼ã€Œæ¬¡ã®å•é¡Œã¸ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>';
                } else if (showOpenBtn) {
                    // ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒã„ã‚‹å ´åˆã¯è§£é™¤ã‚’å¼·èª¿ã€ãã‚Œä»¥å¤–ã¯å›ç­”å†é–‹
                    waitingDisplay.innerHTML = hasPenalty ? '<p class="text-secondary" style="font-size: 1.2rem;">ã€Œå…¨å“¡ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤ã€ã‚’æŠ¼ã™ã¨å…¨å“¡å›ç­”å¯èƒ½ã«ãªã‚Šã¾ã™</p>' : '<p class="text-secondary" style="font-size: 1.2rem;">ã€Œå›ç­”å†é–‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>';
                } else {
                    waitingDisplay.innerHTML = '';
                }

                // ã€Œæ¬¡ã®å•é¡Œã¸ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡:
                // 1. æ­£è§£ãŒå‡ºãŸå¾Œ (WAITING ä¸”ã¤ canAdvance=true) ã®ã¿è¡¨ç¤º
                // 2. ç¬¬1å•é–‹å§‹å‰ (WAITING ä¸”ã¤ openTimestampãªã—) ã¯éè¡¨ç¤ºï¼ˆã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚ã‚‹ãŸã‚ï¼‰
                const showNextBtn = (room.roomState === 'WAITING' && room.canAdvance && room.openTimestamp);
                if (showNextBtn) {
                    nextBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.add('hidden');
                }

                // Undoãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) {
                    if (room.backup) {
                        undoBtn.classList.remove('hidden');
                    } else {
                        undoBtn.classList.add('hidden');
                    }
                }

                // Nextãƒœã‚¿ãƒ³åˆ¶å¾¡ (å‰Šé™¤/çµ±åˆ)


                // æ—©æŠ¼ã—éŸ³ãƒˆãƒªã‚¬ãƒ¼
                if (previousState === 'OPEN' && room.roomState === 'LOCKED') {
                    playSound('buzz');
                }
                previousState = room.roomState;

                // ãƒãƒƒã‚¸
                badge.className = 'badge';
                switch (room.roomState) {
                    case 'WAITING':
                        badge.classList.add('badge-waiting');
                        badge.textContent = 'WAITING';
                        judgeButtons.classList.add('hidden');
                        winnerDisplay.classList.add('hidden');
                        waitingDisplay.classList.remove('hidden');
                        break;
                    case 'OPEN':
                        badge.classList.add('badge-open');
                        badge.textContent = 'OPEN';
                        judgeButtons.classList.add('hidden');
                        winnerDisplay.classList.add('hidden');
                        waitingDisplay.classList.add('hidden');
                        break;
                    case 'LOCKED':
                        badge.classList.add('badge-locked');
                        badge.textContent = 'LOCKED';
                        judgeButtons.classList.remove('hidden');
                        waitingDisplay.classList.add('hidden');
                        if (room.winner) {
                            winnerDisplay.classList.remove('hidden');
                            document.getElementById('winnerName').textContent = room.winner.displayName;
                            document.getElementById('reactionTime').textContent = room.winner.reactionTime || 0;
                        }
                        break;
                }

                updatePlayerList(room.players || {});
                updateSettingsUI();
            }

            function updatePlayerList(players) {
                const playerList = document.getElementById('playerList');
                const playerArray = Object.values(players);
                document.getElementById('playerCount').textContent = playerArray.length;

                if (playerArray.length === 0) {
                    playerList.innerHTML = '<p class="text-muted">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>';
                    return;
                }

                const sorted = playerArray.sort((a, b) => (b.score || 0) - (a.score || 0));

                playerList.innerHTML = sorted.map(p => {
                    const offlineClass = p.connectionStatus === 'offline' ? 'offline' : '';
                    return `
                        <div class="player-item ${offlineClass}">
                            <span class="player-name">${escapeHtml(p.displayName)}</span>
                            <span class="player-score">${p.score || 0}pt</span>
                        </div>
                    `;
                }).join('');
            }

            function updateSettingsUI() {
                document.querySelectorAll('.setting-option').forEach(btn => {
                    const setting = btn.dataset.setting;
                    let value = btn.dataset.value;

                    if (value === 'true') value = true;
                    else if (value === 'false') value = false;
                    else if (!isNaN(value)) value = parseInt(value);

                    if (currentRules[setting] === value) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // åŠ¹æœéŸ³ (MP3)
            const sounds = {
                correct: new Audio('./sounds/correct.mp3'),
                wrong: new Audio('./sounds/wrong.mp3'),
                open: new Audio('./sounds/open.mp3'),
                buzz: new Audio('./sounds/buzz.mp3'),
                end: new Audio('./sounds/end.mp3'),
                end2: new Audio('./sounds/end2.mp3') // è¿½åŠ 
            };

            // é€£ç¶šå†ç”Ÿè¨­å®š
            sounds.end.addEventListener('ended', () => {
                sounds.end2.currentTime = 0;
                sounds.end2.play().catch(e => console.log('end2 play error:', e));
            });

            function playSound(type) {
                const audio = sounds[type];
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Sound play error:', e));
                }
            }

            // é›¢è„±é˜²æ­¢
            window.addEventListener('beforeunload', (e) => {
                // ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼ˆãƒ›ã‚¹ãƒˆä¸­ï¼‰ã®å ´åˆã®ã¿è­¦å‘Š
                if (!mainScreen.classList.contains('hidden')) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
</body>

</html>
