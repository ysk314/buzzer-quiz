<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¯ æ—©æŠ¼ã—ã‚¯ã‚¤ã‚º - ãƒ›ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        .host-container {
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .control-center {
            text-align: center;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .judge-buttons {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
        }

        .judge-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setup-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setup-card {
            max-width: 500px;
            width: 100%;
        }

        .share-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 600px) {
            .share-section {
                grid-template-columns: 1fr;
            }
        }

        .player-grid {
            display: grid;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
    <div id="setupScreen" class="setup-screen">
        <div class="card setup-card text-center">
            <h1>ğŸ‘‘ ãƒ›ã‚¹ãƒˆè¨­å®š</h1>

            <!-- é¸æŠç”»é¢ -->
            <div id="choiceSection">
                <p class="text-secondary mb-lg">ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ ã®è¨­å®šã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div class="control-buttons" style="flex-direction: column; gap: 16px;">
                    <button class="btn btn-primary btn-large" id="showCreateBtn" style="width: 100%;">
                        ğŸ“ æ–°ã—ããƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹
                    </button>
                    <button class="btn btn-secondary btn-large" id="showResumeBtn" style="width: 100%;">
                        ğŸ”„ ãƒ«ãƒ¼ãƒ ã‚’å†é–‹ã™ã‚‹
                    </button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ ä½œæˆå‰ -->
            <div id="createSection" class="hidden">
                <h3 class="mb-md">æ–°è¦ãƒ«ãƒ¼ãƒ ä½œæˆ</h3>
                <p class="text-secondary mb-lg">æ–°ã—ã„6æ¡ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã—ã¾ã™</p>
                <div class="control-buttons">
                    <button class="btn btn-secondary" id="backToChoiceBtn1">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="createRoomBtn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ å†é–‹ -->
            <div id="resumeSection" class="hidden">
                <h3 class="mb-md">ãƒ«ãƒ¼ãƒ å†é–‹</h3>
                <div class="input-group text-left" style="margin-bottom: 16px;">
                    <label>ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ (6æ¡)</label>
                    <input type="text" class="input" id="resumeRoomCode" placeholder="123456" maxlength="6"
                        pattern="[0-9]{6}">
                </div>
                <div class="input-group text-left">
                    <label>ãƒ›ã‚¹ãƒˆPIN (4æ¡)</label>
                    <input type="text" class="input" id="resumePin" placeholder="XXXX" maxlength="4" pattern="[0-9]{4}">
                </div>
                <div class="control-buttons mt-lg">
                    <button class="btn btn-secondary" id="backToChoiceBtn2">æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="resumeRoomBtn">å†é–‹ã™ã‚‹</button>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ ä½œæˆå¾Œ -->
            <div id="roomCreatedSection" class="hidden">
                <p class="text-secondary mb-md" id="roomCreatedMsg">ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼</p>

                <div class="room-code" id="displayRoomCode"></div>

                <div class="mt-lg">
                    <p class="text-muted mb-sm">å‚åŠ URL</p>
                    <input type="text" class="input" id="shareUrl" readonly style="text-align: center;">
                    <button class="btn btn-small btn-secondary mt-sm" id="copyUrlBtn">
                        ğŸ“‹ ã‚³ãƒ”ãƒ¼
                    </button>
                </div>

                <div class="mt-lg" id="pinDisplaySection">
                    <p class="text-muted mb-sm">ãƒ›ã‚¹ãƒˆPINï¼ˆãƒ¡ãƒ¢ã—ã¦ãã ã•ã„ï¼‰</p>
                    <div class="room-code" id="displayPin" style="font-size: 2rem;"></div>
                </div>

                <div class="mt-lg">
                    <button class="btn btn-primary btn-large" id="autoJoinBtn">
                        ğŸš€ ãƒ›ã‚¹ãƒˆã¨ã—ã¦é–‹å§‹
                    </button>
                    <button class="btn btn-secondary mt-md" id="settingsTogglePre" style="width: 100%;">
                        âš™ï¸ ãƒ«ãƒ¼ãƒ«è¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="host-container hidden">
        <header class="header">
            <div class="room-info">
                <div class="info-item">
                    <span class="info-label">ãƒ«ãƒ¼ãƒ </span>
                    <span class="info-value" id="headerRoomCode">---</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å‚åŠ è€…</span>
                    <span class="info-value"><span id="playerCount">0</span>äºº</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ãƒ©ã‚¦ãƒ³ãƒ‰</span>
                    <span class="info-value">#<span id="roundNumber">1</span></span>
                </div>
                <div id="roomStateBadge" class="badge badge-waiting">WAITING</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button id="finishGameBtn" class="btn btn-small btn-danger">çµ‚äº†</button>
                <a href="index.html" class="btn btn-small btn-secondary">æˆ»ã‚‹</a>
            </div>
        </header>

        <div class="main-grid">
            <div class="card control-center">
                <h2>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« <span id="questionNumberDisplay"
                        style="font-size: 0.8em; margin-left: 10px; color: var(--accent-cyan);">ç¬¬1å•</span></h2>

                <!-- å…ˆç€è€…è¡¨ç¤º -->
                <div id="winnerDisplay" class="winner-display hidden mt-lg">
                    <p class="text-muted">å…ˆç€</p>
                    <div class="winner-name" id="winnerName">---</div>
                    <div class="winner-time"><span id="reactionTime">0</span> ms</div>
                </div>

                <!-- å¾…æ©Ÿæ™‚è¡¨ç¤º -->
                <div id="waitingDisplay" class="mt-lg">
                    <p class="text-secondary" style="font-size: 1.2rem;">ã€Œå›ç­”å†é–‹ã€ã‚’æŠ¼ã—ã¦æ—©æŠ¼ã—ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
                </div>

                <!-- åˆ¤å®šãƒœã‚¿ãƒ³ -->
                <div id="judgeButtons" class="judge-buttons hidden">
                    <button class="btn btn-success judge-btn" id="correctBtn">â—‹</button>
                    <button class="btn btn-danger judge-btn" id="wrongBtn">Ã—</button>
                </div>

                <!-- é€²è¡Œãƒœã‚¿ãƒ³ -->
                <div class="control-buttons">
                    <button class="btn btn-primary btn-large" id="openBtn">
                        ğŸ”“ å›ç­”å†é–‹ (Open)
                    </button>
                    <button class="btn btn-secondary" id="nextBtn">
                        â¡ï¸ æ¬¡ã¸ (Next)
                    </button>
                </div>
            </div>

            <div class="card">
                <h3 class="mb-md">å‚åŠ è€…ä¸€è¦§</h3>
                <div id="playerList" class="player-grid">
                    <p class="text-muted">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>

        <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
        <button class="btn btn-icon btn-secondary settings-toggle" id="settingsToggle">
            âš™ï¸
        </button>
    </div>

    <!-- è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="settingsOverlay" class="settings-overlay">
        <div class="settings-modal">
            <div class="flex-between mb-lg">
                <h2>âš™ï¸ ãƒ«ãƒ¼ãƒ«è¨­å®š</h2>
                <button class="btn btn-small btn-secondary" id="closeSettings">âœ• é–‰ã˜ã‚‹</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">èª¤ç­”ãƒšãƒŠãƒ«ãƒ†ã‚£</span>
                <div class="setting-options">
                    <button class="setting-option" data-setting="penaltyType" data-value="none">ãªã—</button>
                    <button class="setting-option active" data-setting="penaltyType"
                        data-value="thisRound">å½“å•ãƒ­ãƒƒã‚¯</button>
                    <button class="setting-option" data-setting="penaltyType" data-value="nextRound">æ¬¡å•ã‚‚ãƒ­ãƒƒã‚¯</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">æ­£è§£åŠ ç‚¹</span>
                <div class="setting-options">
                    <button class="setting-option" data-setting="correctPoints" data-value="0">ãªã—</button>
                    <button class="setting-option active" data-setting="correctPoints" data-value="1">+1</button>
                    <button class="setting-option" data-setting="correctPoints" data-value="2">+2</button>
                    <button class="setting-option" data-setting="correctPoints" data-value="3">+3</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">èª¤ç­”æ¸›ç‚¹</span>
                <div class="setting-options">
                    <button class="setting-option active" data-setting="wrongPoints" data-value="0">ãªã—</button>
                    <button class="setting-option" data-setting="wrongPoints" data-value="1">-1</button>
                    <button class="setting-option" data-setting="wrongPoints" data-value="2">-2</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">å¾—ç‚¹ä¸‹é™</span>
                <div class="setting-options">
                    <button class="setting-option active" data-setting="allowNegative" data-value="false">0ã¾ã§</button>
                    <button class="setting-option" data-setting="allowNegative" data-value="true">ãƒã‚¤ãƒŠã‚¹ã‚ã‚Š</button>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">èª¤ç­”å¾Œã®å‡¦ç†</span>
                <div class="setting-options">
                    <button class="setting-option active" data-setting="wrongAction" data-value="reopen">å†è§£æ”¾</button>
                    <button class="setting-option" data-setting="wrongAction" data-value="nextInQueue">ç¹°ã‚Šä¸Šã’</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/firebase-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let roomCode = null;
            let currentRules = {};
            let previousState = null; // å‰å›ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ä¿æŒ

            const setupScreen = document.getElementById('setupScreen');
            const mainScreen = document.getElementById('mainScreen');
            const createSection = document.getElementById('createSection');
            const roomCreatedSection = document.getElementById('roomCreatedSection');
            const choiceSection = document.getElementById('choiceSection');
            const resumeSection = document.getElementById('resumeSection');

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('showCreateBtn').onclick = () => {
                choiceSection.classList.add('hidden');
                createSection.classList.remove('hidden');
            };

            document.getElementById('showResumeBtn').onclick = () => {
                choiceSection.classList.add('hidden');
                resumeSection.classList.remove('hidden');
            };

            document.getElementById('backToChoiceBtn1').onclick = () => {
                createSection.classList.add('hidden');
                choiceSection.classList.remove('hidden');
            };

            document.getElementById('backToChoiceBtn2').onclick = () => {
                resumeSection.classList.add('hidden');
                choiceSection.classList.remove('hidden');
            };

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ï¼ˆå†é–‹ãƒ¢ãƒ¼ãƒ‰ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');

            if (roomFromUrl) {
                // URLã«ãƒ«ãƒ¼ãƒ ãŒã‚ã‚‹å ´åˆã¯å†é–‹ãƒ¢ãƒ¼ãƒ‰ã¸ç›´è¡Œ
                choiceSection.classList.add('hidden');
                resumeSection.classList.remove('hidden');
                document.getElementById('resumeRoomCode').value = roomFromUrl;
            }

            document.getElementById('createRoomBtn').addEventListener('click', async () => {
                try {
                    const result = await roomManager.createRoom();
                    roomCode = result.roomCode;

                    document.getElementById('displayRoomCode').textContent = roomCode;
                    document.getElementById('displayPin').textContent = result.pin;

                    // URLæ›´æ–°
                    const newUrl = `${window.location.pathname}?room=${roomCode}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);

                    const shareUrl = `${window.location.origin}${window.location.pathname.replace('host.html', '')}player.html?room=${roomCode}`;
                    document.getElementById('shareUrl').value = shareUrl;

                    // PINè¡¨ç¤º
                    document.getElementById('roomCreatedMsg').style.display = 'block';
                    document.getElementById('pinDisplaySection').style.display = 'block';

                    // è‡ªå‹•å‚åŠ ãƒœã‚¿ãƒ³
                    document.getElementById('autoJoinBtn').onclick = async () => {
                        await enterHostMode(roomCode, result.pin);
                    };

                    createSection.classList.add('hidden');
                    roomCreatedSection.classList.remove('hidden');
                } catch (error) {
                    alert('ãƒ«ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });

            async function enterHostMode(code, pin) {
                try {
                    const valid = await roomManager.verifyPin(code, pin);
                    if (valid) {
                        setupScreen.classList.add('hidden');
                        mainScreen.classList.remove('hidden');
                        document.getElementById('headerRoomCode').textContent = code;

                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
                        roomManager.onRoomUpdate((room) => {
                            if (room) {
                                updateUI(room);
                            }
                        });
                    } else {
                        alert('PINãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }
                } catch (error) {
                    alert('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            // URLã‚³ãƒ”ãƒ¼
            document.getElementById('copyUrlBtn').addEventListener('click', () => {
                const urlInput = document.getElementById('shareUrl');
                urlInput.select();
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    document.getElementById('copyUrlBtn').textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                    setTimeout(() => {
                        document.getElementById('copyUrlBtn').textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    }, 2000);
                });
            });

            // å†é–‹å®Ÿè¡Œ
            document.getElementById('resumeRoomBtn').onclick = async () => {
                const code = document.getElementById('resumeRoomCode').value;
                const pin = document.getElementById('resumePin').value;
                if (!code || !pin) {
                    alert('ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã¨PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                await enterHostMode(code, pin);
            };

            // è§£æ”¾
            document.getElementById('openBtn').addEventListener('click', async () => {
                playSound('open');
                await roomManager.openBuzz();
            });

            // æ­£è§£
            document.getElementById('correctBtn').addEventListener('click', async () => {
                playSound('correct');
                await roomManager.judge('correct');

                // è‡ªå‹•é€²è¡Œ: 1ç§’å¾Œã«æ¬¡ã¸ -> 0.5ç§’å¾Œã«Open
                setTimeout(async () => {
                    await roomManager.nextRound();
                    setTimeout(async () => {
                        playSound('open');
                        await roomManager.openBuzz();
                    }, 500);
                }, 1000);
            });

            // èª¤ç­”
            document.getElementById('wrongBtn').addEventListener('click', async () => {
                playSound('wrong');
                await roomManager.judge('wrong');

                // è‡ªå‹•å†é–‹: 0.5ç§’å¾Œã«Open (éŸ³ãªã—)
                setTimeout(async () => {
                    // playSound('open'); // åŠ¹æœéŸ³èª¿æ•´
                    await roomManager.openBuzz();
                }, 500);
            });

            // æ¬¡ã¸
            document.getElementById('nextBtn').addEventListener('click', async () => {
                playSound('open');
                await roomManager.nextRound();
            });

            // è¨­å®šãƒˆã‚°ãƒ«
            document.getElementById('settingsToggle').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.add('active');
            });

            document.getElementById('closeSettings').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.remove('active');
            });

            // æº–å‚™ç”»é¢ã®è¨­å®šãƒœã‚¿ãƒ³
            document.getElementById('settingsTogglePre').addEventListener('click', () => {
                document.getElementById('settingsOverlay').classList.add('active');
            });

            // çµ‚äº†ãƒœã‚¿ãƒ³
            document.getElementById('finishGameBtn').addEventListener('click', async () => {
                if (confirm('ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nå‚åŠ è€…ã«çµæœç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚')) {
                    await roomManager.finishGame();
                }
            });

            // è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³
            document.querySelectorAll('.setting-option').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const setting = btn.dataset.setting;
                    let value = btn.dataset.value;

                    if (value === 'true') value = true;
                    else if (value === 'false') value = false;
                    else if (!isNaN(value)) value = parseInt(value);

                    btn.parentElement.querySelectorAll('.setting-option').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    await roomManager.updateRules({ [setting]: value });
                });
            });

            // UIæ›´æ–°
            function updateUI(room) {
                document.getElementById('roundNumber').textContent = room.roundNumber || 1;
                currentRules = room.rules || {};

                const badge = document.getElementById('roomStateBadge');
                const openBtn = document.getElementById('openBtn');
                const nextBtn = document.getElementById('nextBtn');
                const judgeButtons = document.getElementById('judgeButtons');
                const winnerDisplay = document.getElementById('winnerDisplay');
                const waitingDisplay = document.getElementById('waitingDisplay');

                badge.className = 'badge';
                badge.className = 'badge';
                // nextBtn.disabled = !room.canAdvance; // å¸¸ã«æŠ¼ã›ã‚‹ã‚ˆã†ã«å¤‰æ›´

                // Openãƒœã‚¿ãƒ³æ–‡è¨€åˆ¶å¾¡
                if ((room.roundNumber === 1 || !room.roundNumber) && room.roomState === 'WAITING' && !room.openTimestamp) {
                    openBtn.textContent = 'ğŸš€ ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ';
                } else {
                    openBtn.textContent = 'ğŸ”“ å…¨å“¡ãƒšãƒŠãƒ«ãƒ†ã‚£è§£é™¤';
                }

                // å•é¡Œæ•°è¡¨ç¤ºæ›´æ–°
                document.getElementById('questionNumberDisplay').textContent = `ç¬¬${room.roundNumber || 1}å•`;

                // çµ‚äº†çŠ¶æ…‹
                if (room.roomState === 'FINISHED') {
                    badge.classList.add('badge-locked');
                    badge.textContent = 'FINISHED';
                    openBtn.disabled = true;
                    document.getElementById('judgeButtons').classList.add('hidden');
                    document.getElementById('waitingDisplay').innerHTML = '<p class="text-accent">ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼</p>';
                    document.getElementById('waitingDisplay').classList.remove('hidden');
                    return;
                }

                // æ—©æŠ¼ã—éŸ³ã®ãƒˆãƒªã‚¬ãƒ¼ (OPEN -> LOCKED)
                if (previousState === 'OPEN' && room.roomState === 'LOCKED') {
                    playSound('buzz');
                }
                previousState = room.roomState;

                switch (room.roomState) {
                    case 'WAITING':
                        badge.classList.add('badge-waiting');
                        badge.textContent = 'WAITING';
                        openBtn.disabled = false;
                        judgeButtons.classList.add('hidden');
                        winnerDisplay.classList.add('hidden');
                        waitingDisplay.classList.remove('hidden');
                        break;
                    case 'OPEN':
                        badge.classList.add('badge-open');
                        badge.textContent = 'OPEN';
                        openBtn.disabled = true;
                        judgeButtons.classList.add('hidden');
                        winnerDisplay.classList.add('hidden');
                        waitingDisplay.classList.add('hidden');
                        break;
                    case 'LOCKED':
                        badge.classList.add('badge-locked');
                        badge.textContent = 'LOCKED';
                        openBtn.disabled = true;
                        judgeButtons.classList.remove('hidden');
                        waitingDisplay.classList.add('hidden');
                        if (room.winner) {
                            winnerDisplay.classList.remove('hidden');
                            document.getElementById('winnerName').textContent = room.winner.displayName;
                            document.getElementById('reactionTime').textContent = room.winner.reactionTime || 0;
                        }
                        break;
                }

                updatePlayerList(room.players || {});
                updateSettingsUI();
            }

            function updatePlayerList(players) {
                const playerList = document.getElementById('playerList');
                const playerArray = Object.values(players);
                document.getElementById('playerCount').textContent = playerArray.length;

                if (playerArray.length === 0) {
                    playerList.innerHTML = '<p class="text-muted">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>';
                    return;
                }

                const sorted = playerArray.sort((a, b) => (b.score || 0) - (a.score || 0));

                playerList.innerHTML = sorted.map(p => {
                    const offlineClass = p.connectionStatus === 'offline' ? 'offline' : '';
                    return `
                        <div class="player-item ${offlineClass}">
                            <span class="player-name">${escapeHtml(p.displayName)}</span>
                            <span class="player-score">${p.score || 0}pt</span>
                        </div>
                    `;
                }).join('');
            }

            function updateSettingsUI() {
                document.querySelectorAll('.setting-option').forEach(btn => {
                    const setting = btn.dataset.setting;
                    let value = btn.dataset.value;

                    if (value === 'true') value = true;
                    else if (value === 'false') value = false;
                    else if (!isNaN(value)) value = parseInt(value);

                    if (currentRules[setting] === value) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // åŠ¹æœéŸ³ (MP3)
            const sounds = {
                correct: new Audio('./sounds/correct.mp3'),
                wrong: new Audio('./sounds/wrong.mp3'),
                open: new Audio('./sounds/open.mp3'),
                buzz: new Audio('./sounds/buzz.mp3')
            };

            function playSound(type) {
                const audio = sounds[type];
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log('Sound play error:', e));
                }
            }
        });
    </script>
</body>

</html>